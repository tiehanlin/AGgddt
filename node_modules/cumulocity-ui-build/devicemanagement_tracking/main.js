/* devicemanagement_tracking 8.7.2 2017-08-02T09:53:40+00:00 2e289fd803cb (hotfix/8.7.2) tip */
angular.module("c8y.parts.tracking",["leaflet-directive"]).config(["c8yViewsProvider","gettext",function(e,t){e.when("/device/:deviceId",{name:t("Tracking"),templateUrl:"devicemanagement_tracking/views/index.html",icon:"crosshairs",showIf:["$routeParams","c8yDevices",function(e,t){var n=e.deviceId;return t.detailCached(n).then(function(e){var t=e.data;return t&&t.c8y_Position})}]})}]),function(){"use strict";function e(e,t,n,a,i,r,c,o,l,s){function d(){p.hideAll();var e=p.dateFrom,t=p.dateTo;p.map.tracker.changeInterval({dateFrom:e&&moment(e).format(a.dateFullFormat),dateTo:t&&moment(t).format(a.dateFullFormat)}).then(function(){p.map.tracker.activate(p.deviceId,u)})}function m(){return p.map&&p.map.tracker&&p.map.tracker.loadMore&&p.map.tracker.loadMore[p.deviceId]}function g(){return l.detail(p.deviceId).then(a.getResData).then(s.gsmTrackingAvailable)}function v(){p.hideAll(),u={gps:"all"===p.trackingOption||"gps"===p.trackingOption,gsm:"all"===p.trackingOption||"gsm"===p.trackingOption},p.map.tracker.activate(p.deviceId,u)}var p=this;p.deviceId=t.deviceId;var u={gps:!0,gsm:!0},f=[{txt:r("Last hour"),time:"hour"},{txt:r("Last day"),time:"day"},{txt:r("Last week"),time:"week"},{txt:r("Last month"),time:"month"},{txt:r("Custom"),time:"custom"}];p.markers={},p.checkDateTo=function(){var e=moment(p.dateFrom);p.dateTo&&e.diff(moment(p.dateTo),"days")>=0&&(p.dateTo=e.clone().add("day",1).toDate())},p.toggle=function(e,t){if(p.markers["p"+e])p.map.leafletMap.removeLayer(p.markers["p"+e]),delete p.markers["p"+e];else{var a=i.getLocationFragment(t);a&&(p.markers["p"+e]=L.marker(L.latLng(a.lat,a.lng)).bindPopup(n("date")(t.time,"medium")).addTo(p.map.leafletMap))}},p.hideAll=function(){_.forEach(p.markers,function(e){p.map.leafletMap.removeLayer(e)}),p.markers={}},p.events=function(){var e=p.map&&p.map.tracker.events[p.deviceId];return _.filter(e,{type:"c8y_LocationUpdate"})},p.hasLoadMore=function(){return m()},p.loadMore=function(){var e=m();return e&&e()},p.markerTemplate=c.tracking.markerTemplate||null,p.realtime=c.tracking.realtime||!1,p.legend=c.tracking.legend||!1,p.eventText=c.tracking.eventText||!1,p.timeIntervals=f,p.onTrackingOptionChange=v,p.showTrackingOptions=!1,g().then(function(e){p.showTrackingOptions=e}),p.trackingOption="all",e.$on("search",d)}e.$inject=["$scope","$routeParams","$filter","c8yBase","c8yGeo","gettext","c8yConfig","c8yApplication","c8yDevices","c8yCombain"],angular.module("c8y.parts.tracking").controller("trackingCtrl",e)}(),function(){"use strict";function e(e,t,n,a,i,r,c){function o(t){e.geofence=t.c8y_Geofence&&t.c8y_Geofence.active,e.motion=t.c8y_MotionTracking&&t.c8y_MotionTracking.active||!1,e.radius=t.c8y_Geofence&&t.c8y_Geofence.radius||100}function l(t){return a.supportsOperation(e.device,t)}function s(){var n=[],i=e.device,r=i.id,o=i.c8y_Position;return e.geofence&&!o?void p(c("Device current position not defined")):(a.supportsOperation(i,"c8y_Geofence")&&n.push(g(r,o,e.radius,e.geofence)),a.supportsOperation(i,"c8y_MotionTracking")&&n.push(v(r,e.motion)),void(n.length?t.all(n).then(function(){e.$emit("message",{text:c("Operations created"),type:"success"})}):_.isUndefined(e.radius)||(d(i),m(i))))}function d(t){_.assign(t,{c8y_Radius:{value:e.radius}},{c8y_CopyPosition:_.cloneDeep(t.c8y_Position)})}function m(e){i.save(e).then(function(){r.success(c("Changes saved successfully!"))})}function g(e,t,a,i){var r=c(i?"Activate geofence":"Deactivate geofence");return n.create({deviceId:e,description:r,c8y_Geofence:{lat:t&&t.lat,lng:t&&t.lng,radius:a,active:!0}})}function v(e,t){var a=c(t?"Activate motion tracking":"Deactivate motion tracking");return n.create({deviceId:e,description:a,c8y_MotionTracking:{active:!!t}})}function p(t){e.$emit("message",{text:t,type:"error"})}e.supports=l,e.updateConfig=s;var u=e.$watch("device",function(e){e&&e.id&&(o(e),u())})}angular.module("c8y.parts.tracking").controller("trackingConfigCtrl",["$scope","$q","c8yDeviceControl","c8yDevices","c8yInventory","c8yAlert","gettext",e])}(),function(){"use strict";function e(e){var t;t='<div ng-controller="trackingCtrl as ctrl">\n\n\n  <div class="row">\n\n    <div class="col-lg-8">\n      <div c8y-map-internal map="ctrl.map" marker-template="ctrl.markerTemplate" c8y-legend="ctrl.legend" device-id="ctrl.deviceId" style="margin-bottom:15px;height:500px" realtime="ctrl.realtime">\n      </div>\n    </div>\n    <div class="col-lg-4">\n      <div class="row" style="margin-bottom:10px">\n        <div class="col-lg-12">\n          <form class="form-inline pull-right">\n            <c8y-realtime-btn-2 state="ctrl.map.state()" data-start-rt="ctrl.map.startRt()" data-stop-rt="ctrl.map.stopRt()"></c8y-realtime-btn-2>\n            <select class="form-control" ng-model="ctrl.trackingOption" ng-change="ctrl.onTrackingOptionChange()" ng-if="ctrl.showTrackingOptions">\n              <option value="all" translate>Show all data</option>\n              <option value="gps" translate>Show GPS data only</option>\n              <option value="gsm" translate>Show GSM data only</option>\n            </select>\n            <c8y-time-interval date-from="ctrl.dateFrom" date-to="ctrl.dateTo"></c8y-time-interval>\n          </form>\n        </div>\n      </div>\n      <div class="panel panel-clean">\n        <div class="panel-body">\n          <div class="alert alert-warning" ng-show="events.length == 0" style="margin-top:15px">\n            {{\'No events found\' | translate}}\n          </div>\n        </div>\n\n        <div style="max-height:400px; overflow: auto">\n          <table class="table table-condensed" ng-hide="ctrl.events().length == 0">\n            <tr class="interact" ng-repeat="event in ctrl.events()" ng-click="ctrl.toggle($index, event)" ng-class="{info: !!ctrl.markers[\'p\'+$index]}">\n              <td>{{event.time|date:\'medium\'}}</td>\n              <td ng-if="ctrl.eventText" class="word-break">{{event.text}}</td>\n            </tr>\n          </table>\n          <a href="" class="btn btn-link btn-block" ng-click="ctrl.loadMore()" ng-show="ctrl.hasLoadMore()">{{\'Load more\' | translate}}</a>\n        </div>\n        <div class="panel-footer" ng-show="ctrl.events().length">\n          <button type="button" class="btn btn-default btn-sm" ng-click="ctrl.hideAll()">{{\'Hide all markers\' | translate}}</button>\n\n        </div>\n      </div>\n\n    </div>\n  </div>\n</div>\n',e.put("devicemanagement_tracking/views/index.html",t),e.put("/apps/devicemanagement/tracking/views/index.html",t)}angular.module("c8y.parts.tracking").run(["$templateCache",e])}();