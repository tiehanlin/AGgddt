/* devicemanagement_groupsHierarchy 8.7.2 2017-08-02T09:53:39+00:00 2e289fd803cb (hotfix/8.7.2) tip */
angular.module("c8y.groupsHierarchy",["c8y.deviceSelector"]).constant("parentNavigatorItemName","Groups").constant("groupsHierarchyPluginPath","devicemanagement_groupsHierarchy").config(["c8yNavigatorProvider","c8yViewsProvider","parentNavigatorItemName","c8yBreadcrumbsProvider","c8yTitleProvider","gettext","$routeProvider",function(e,n,t,i,r,a,s){"use strict";function o(e,n,t,i){d=n,g=t,p=i;var r=null,s=e.groupId,o=n.when(null);if(s&&(o=i.detail(s,{withParents:!0}).then(t.getResData)),s){f[s]&&(r=n.when(f[s]));var u=o.then(function(e){return l([],[],e).then(function(e){return _.forEach(e,function(e){e.unshift({label:a("Groups"),path:"#/group"})}),e=c(e),f[s]=e,e})});r=r||u}return r||n.when([])}function c(e){return _.sortBy(e,function(e){return-1*e.length})}function l(e,n,t){return t?(n.unshift(u(t)),d.all([p.directParentDevices(t),p.directParentAssets(t)]).then(function(t){var i=[].concat(t[0]).concat(t[1]);if(0===i.length)return e.push(n),d.when(e);var r=[];return _.forEach(i,function(t){r.push(p.detail(t.id,{withParents:!0}).then(g.getResData).then(function(t){return d.when(l(e,_.cloneDeep(n),t))}))}),d.all(r).then(function(){return e})})):d.when(e)}function u(e){return{groupType:e.type,label:e.name||"Group "+e.id,path:"#/group/"+e.id,icon:"folder-open",isDevice:!1,isGroup:!0}}a("Groups");var d,g,p,m="/group",v=m+"/:groupId",h="/group/:groupId",y=["$routeParams","$q","c8yBase","c8yInventory",o],f={};e.addNavigation({parent:t,name:a("Groups"),priority:1960,path:"group",icon:"folder-open"}),n.when(m,{templateUrl:"devicemanagement_groupsHierarchy/views/groupsList.html",controller:"groupsListCtrl"}),n.when(v,{name:a("Sub-assets"),icon:"folder-open",templateUrl:"devicemanagement_groupsHierarchy/views/groupsList.html",controller:"groupsListCtrl",priority:1e4}),s.when("/groups",{redirectTo:"/group"}),s.when("/groups/:path*",{redirectTo:"/group/:path"}),n.when(h,{name:a("Details"),priority:1e3,icon:"asterisk",templateUrl:"devicemanagement_groupsHierarchy/views/groupDetails.html",controller:["$scope","$routeParams","c8yBase","c8yInventory",function(e,n,t,i){e.group={},i.detail(n.groupId).then(t.getResData).then(function(n){e.group=n})}]}),n.when(h,{name:a("Devices"),priority:1e3,icon:"code-fork",templateUrl:"devicemanagement_groupsHierarchy/views/groupDevices.html",controller:["$scope","$routeParams","c8yBase","c8yInventory",function(e,n,t,i){e.group={},i.detail(n.groupId).then(t.getResData).then(function(n){e.group=n})}]}),_.forEach([v,h],function(e){r.addTitle(e,{data:["$routeParams","c8yBase","c8yInventory",function(e,n,t){var i=e.groupId;return i?t.detailCached(i).then(n.getResData).then(function(e){return{title:e.name}}):{}}]})}),i.addBreadcrumbs(v,{data:y}),i.addBreadcrumbs(h,{data:y})}]).run(["groupTypesHierarchyNavigator",function(e){"use strict";e.loadAll()}]),angular.module("c8y.groupsHierarchy").controller("groupsListCtrl",["$scope","$location","c8yInventory","c8yBase","c8yDevices","c8yModal","c8yAlert","c8yTitle","c8yUser","c8yGroupTypesConfig","c8yGroups","c8yConfig","groupTypesHierarchyNavigator","$routeParams","$q","gettext","gettextCatalog",function(e,n,t,i,r,a,s,o,c,l,u,d,g,p,m,v,h){"use strict";function y(){return f().then(b).then(w).then(D).then(x).then(A).then(G).then(C)}function f(){return l.get()}function b(n){e.groupTypesConfig=J=n}function w(){return l.getLookup(J)}function D(n){e.groupTypesConfigLookup=z=n}function x(){return p.groupId?t.detail(p.groupId,{withParents:!0}).then(i.getResData):m.when(null)}function A(n){e.currentGroup=K=n}function G(){return K?u.getGroupItems(K):u.getTopLevelGroups()}function C(n){e.items=Q=n,e.paging={refresh:j},N()}function N(){S(K?K.name:v("Groups")),T(Q?h.getString("Showing {{itemsLength}} items",{itemsLength:Q.length}):void 0)}function S(e){o.changeTitle({title:e})}function T(e){o.changeTitle({subtitle:e})}function k(){e.newGroup={groupType:H(),name:""}}function H(){return p.groupId?l.getDeviceSubgroupType():l.getDeviceGroupType()}function $(){delete e.newGroup}function I(e){var n=m.when(P(e)).then(t.createConfirm).then(i.getResData),r=n.then(L).then(G).then(C),a=n.then(B);return m.all([n,r,a]).then(_.partial(s.success,h.getString("Group {{name}} has been created!",{name:e.name}))).then($)}function P(e){var n=_.cloneDeep(e);return n[W]={},n.type=n.groupType.type,delete n.groupType,n}function L(e){if(K)return t.addChildAsset(K,e)}function B(e){K||g.addGroupNavigation(e)}function U(e){n.url("/group/"+e.id)}function M(e){e.childAssets.references.length>0||e.childDevices.references.length>0?s.warning(v("This group is not empty! First remove its children.")):a({title:v("Confirm delete?"),body:h.getString('Do you really want to remove group "{{name}}"?',{name:e.name}),status:"danger"}).then(angular.bind(t,t.remove,e)).then(_.partial(_.pull,Q,e)).then(N).then(_.partial(g.removeGroupNavigation,e))}function O(e){n.url("/group/"+e.id)}function E(e){n.url("/device/"+e.id)}function R(e){n.url("/device/"+e.id+"/alarms")}function q(e){return!u.isGroup(e)&&!r.isDevice(e)}function j(){e.refreshLoading=!0,G().then(C).finally(function(){e.refreshLoading=!1})}function F(e){a({title:v("Confirm unassignment?"),body:h.getString('Do you really want to unassign device "{{name}}"?',{name:e.name})}).then(angular.bind(t,t.removeChildAsset,K,e)).then(function(){_.remove(Q,function(n){return n.id==e.id})})}function V(){a({templateUrl:"devicemanagement_groupsHierarchy/views/groupDeviceAssignment.html",controller:"groupDeviceAssignmentCtrl",resolve:{currentGroup:function(){return K}}}).then(j)}var z,J,K,Q,W="c8y_IsDeviceGroup";e.addNewGroup=k,e.cancelNewGroup=$,e.refresh=j,e.onClickEditGroup=U,e.onClickDeleteGroup=M,e.onClickUnassignDevice=F,e.saveNewGroup=I,e.drillDown=O,e.goToDeviceDetails=E,e.goToDeviceAlarms=R,e.isGroup=u.isGroup,e.isDevice=r.isDevice,e.isOtherItem=q,e.assignDevices=V,e.deviceModel=r.model,e.deviceSerial=r.serial,e.c8yConfig=d,y()}]),angular.module("c8y.groupsHierarchy").controller("groupDetailsCtrl",["$scope","$location","c8yInventory","c8yBase","c8yModal","c8yAlert","c8yTitle","c8yUser","c8yGroupTypesConfig","c8yGroups","c8yConfig","groupTypesHierarchyNavigator","$routeParams","$q","gettext","gettextCatalog",function(e,n,t,i,r,a,s,o,c,l,u,d,g,p,m,v){"use strict";function h(e){e.owner&&y(e.owner)}function y(n){o.detail(n).then(function(n){e.owner=n.data})}function f(e){t.save(e).then(_.partial(a.success,v.getString('Group "{{name}}" saved successfully!',{name:e.name}))).then(b).then(w)}function b(){s.changeTitle({title:e.group.name})}function w(){d.updateGroupNavigation(e.group)}e.save=f,e.$watch("group",h),e.c8yConfig=u}]),angular.module("c8y.groupsHierarchy").controller("groupDevicesCtrl",["$scope","$q","c8yInventory","c8yDevices","c8yModal","gettext","gettextCatalog",function(e,n,t,i,r,a,s){"use strict";function o(){return n.when(e.group)}function c(e){if(e.id)return l(e).then(u)}function l(e){return n.all([i.childAssets(e),i.childDevices(e)]).then(function(e){var n=[];return n.push(e[0]),n.push(e[1]),_.flattenDeep(n)})}function u(n){e.devices=n}function d(n){r({title:a("Confirm unassignment?"),body:s.getString('Do you really want to unassign device "{{name}}"?',{name:n.name})}).then(angular.bind(t,t.removeChildAsset,e.group,n)).then(function(){_.remove(e.devices,function(e){return e.id==n.id})})}function g(){r({templateUrl:"devicemanagement_groupsHierarchy/views/groupDeviceAssignment.html",controller:"groupDeviceAssignmentCtrl",resolve:{currentGroup:function(){return e.group}}}).then(p)}function p(){return o().then(c)}function m(e){return!i.isDevice(e)}function v(e){$location.url("/device/"+e.id)}function h(e){$location.url("/device/"+e.id+"/alarms")}e.refresh=p,e.paging={refresh:_.noop},e.assignDevices=g,e.unassign=d,e.isDevice=i.isDevice,e.isOtherItem=m,e.goToDeviceDetails=v,e.goToDeviceAlarms=h,e.model=i.model,e.serial=i.serial,e.$watch("group",c)}]),angular.module("c8y.groupsHierarchy").controller("groupDeviceAssignmentCtrl",["$scope","$routeParams","$uibModalInstance","$q","c8yBase","c8yInventory","c8yDevices","currentGroup","gettext",function(e,n,t,i,r,a,s,o,c){"use strict";function l(){if(o.id)return i.all([s.childAssets(o),s.childDevices(o)]).then(function(n){d=[],d.push(n[0]),d.push(n[1]),e.alreadyAssignedDevices=d=_.flattenDeep(d)})}function u(e){var n=i.when();_.forEach(e,function(e){n=n.then(_.partial(a.addChildAsset,o,e)).then(function(){d.push(e)})}),n.then(function(){e.length=0}).then(t.close)}var d;e.title=c("Assign devices"),e.assign=u,e.isDevice=s.isDevice,e.dismiss=t.dismiss,l()}]),angular.module("c8y.groupsHierarchy").factory("groupTypesHierarchyNavigator",["c8yNavigator","c8yInventory","c8yGroupTypesConfig","c8yGroups","c8yDevices","parentNavigatorItemName",function(e,n,t,i,r,a){"use strict";function s(e){e.loading||(e.loading=!0,i.getGroupItems(e.group_id).then(_.partial(o,e)))}function o(n,t){n.removeAllChildren(),n.loading=!1;var i=_.map(t,function(e){var t=m(e,n.is_device);return t.parent=n.hash,t}),r=e.addNavigation(i);_.forEach(r,function(e){e.on("expand",s).on("collapse",c)})}function c(e){e.removeAllChildren()}function l(){t.getLookup().then(function(e){_.forEach(e,function(e,t){n.list({type:t}).then(function(e){_(e).sortBy(function(e){return e.name.toLowerCase()}).forEach(u)})})})}function u(n){e.addNavigation(m(n)).on("expand",s).on("collapse",c)}function d(n){var t=e.findNode(p(n));t&&t.update(m(n))}function g(n){var t=e.findNode(p(n));e.removeNavigation(t)}function p(e){return function(n){return n.group_id===e.id}}function m(e,n){var t=!!(e.c8y_IsDevice||n||r.isChildDevice(e)),i=(t?"device":"group")+"/"+e.id;return{group_id:e.id,is_device:t,parent:a,name:e.name,priority:1950,path:i,icon:t?"cog":"folder-open"}}return{loadAll:l,addGroupNavigation:u,updateGroupNavigation:d,removeGroupNavigation:g}}]),function(){"use strict";function e(e){var n;n='<div ng-controller="groupDetailsCtrl">\n  <form name="groupDetailsForm" ng-submit="save(group)" novalidate>\n    <div class="row">\n      <div class="panel panel-clean">\n        <div class="panel-body">\n          <div class="col-sm-6">\n            <div class="form-group">\n              <label for="group-name">{{\'Name\' | translate}}</label>\n              <input id="group-name" type="text" class="form-control" ng-model="group.name" maxlength="{{c8yConfig.validation.groupName.maxlength}}" required>\n            </div>\n            <div class="form-group">\n              <label for="group-type">{{\'Type\' | translate}}</label>\n              <input id="group-type" type="text" class="form-control" ng-model="group.type" disabled="disabled">\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n\n    <div>\n      <button type="submit" class="btn btn-primary" ng-disabled="groupDetailsForm.$invalid" translate>\n        Save changes\n      </button>\n    </div>\n  </form>\n</div>\n',e.put("devicemanagement_groupsHierarchy/views/groupDetails.html",n),e.put("/apps/devicemanagement/groupsHierarchy/views/groupDetails.html",n),n='<div class="modal-header" ng-show="title">\n  <h3>{{title}}</h3>\n</div>\n<div class="modal-body">\n  <c8y-device-selector selected-devices="selectedDevices" disabled-devices="alreadyAssignedDevices"></c8y-device-selector>\n</div>\n<div class="modal-footer">\n  <button class="btn btn-primary" ng-disabled="selectedDevices.length == 0" ng-click="assign(selectedDevices)" translate translate-n="selectedDevices.length" translate-plural="Assign {{selectedDevices.length}} devices">\n    Assign {{selectedDevices.length}} device\n  </button>\n  <button class="btn btn-default" ng-click="dismiss()" translate>Close</button>\n</div>\n',e.put("devicemanagement_groupsHierarchy/views/groupDeviceAssignment.html",n),e.put("/apps/devicemanagement/groupsHierarchy/views/groupDeviceAssignment.html",n),n='<div ng-controller="groupDevicesCtrl">\n  <div class="navbar">\n    <div class="nav navbar-right">\n      <a class="btn btn-link" ng-click="assignDevices()">\n        <i c8y-icon="plus"></i> {{\'Assign devices\' | translate}}\n      </a>\n      <c8y-refresh-btn></c8y-refresh-btn>\n    </div>\n  </div>\n\n  <div class="alert alert-warning" ng-show="devices.length == 0" translate>\n    No devices assigned to group.\n  </div>\n\n  <table class="table table-hover">\n    <tr ng-repeat="dev in devices | filter:isDevice">\n      <td style="width:30px" class="text-center">\n        <c8y-device-status-display device="dev"></c8y-device-status-display>\n      </td>\n\n      <td class="word-break">\n        {{dev.name || \'Device \' + dev.id}}\n        <small ng-if="model(dev)" class="text-muted hidden-sm hidden-xs" style="margin-right:10px"><strong translate>Model:</strong> {{model(dev)}}</small>\n        <small ng-if="serial(dev)" class="text-muted hidden-sm hidden-xs"><strong translate>S/N:</strong> {{serial(dev)}}</small>\n      </td>\n\n      <td class="text-right interact" ng-click="goToDeviceAlarms(dev)">\n        <small class="status critical" ng-if="dev.c8y_ActiveAlarmsStatus.critical">\n          {{dev.c8y_ActiveAlarmsStatus.critical}} <i c8y-icon="warning"></i>\n        </small>\n        <small class="status major" ng-if="dev.c8y_ActiveAlarmsStatus.major">\n          {{dev.c8y_ActiveAlarmsStatus.major}} <i c8y-icon="exclamation-circle"></i>\n        </small>\n        <small class="status minor" ng-if="dev.c8y_ActiveAlarmsStatus.minor">\n          {{dev.c8y_ActiveAlarmsStatus.minor}} <i c8y-icon="exclamation-circle"></i>\n        </small>\n        <small class="status warning" ng-if="dev.c8y_ActiveAlarmsStatus.warning">\n          {{dev.c8y_ActiveAlarmsStatus.warning}} <i c8y-icon="circle"></i>\n        </small>\n      </td>\n\n      <td class="text-right">\n        <button class="btn btn-danger btn-xs showOnHover" title="{{\'Unassign device\' | translate}}" ng-click="unassign(dev)">\n          <i c8y-icon="times"></i>\n        </button>\n      </td>\n    </tr>\n    <tr ng-repeat="dev in devices | filter:isOtherItem">\n      <td style="width:30px" class="text-center">&nbsp;</td>\n\n      <td>\n        {{dev.name || \'Device \' + dev.id}}\n        <small ng-if="model(dev)" class="text-muted hidden-sm hidden-xs" style="margin-right:10px"><strong translate>Model:</strong> {{model(dev)}}</small>\n        <small ng-if="serial(dev)" class="text-muted hidden-sm hidden-xs"><strong translate>S/N:</strong> {{serial(dev)}}</small>\n      </td>\n\n      <td>\n\n      </td><td class="text-right">\n        <button class="btn btn-danger btn-xs showOnHover" title="{{\'Unassign item\' | translate}}" ng-click="unassign(dev)">\n          <i c8y-icon="times"></i>\n        </button>\n      </td>\n    </tr>\n  </table>\n</div>\n',e.put("devicemanagement_groupsHierarchy/views/groupDevices.html",n),e.put("/apps/devicemanagement/groupsHierarchy/views/groupDevices.html",n),n='<div>\n  <ul class="breadcrumbs text-muted">\n    <li ng-repeat="breadcrumb in breadcrumbs" ng-show="!$last">\n      <span ng-show="!$first"> / </span>\n      <a ng-show="breadcrumb.type == \'grouptype\'" ng-href="#/{{breadcrumb.type}}/{{breadcrumb.name}}">{{breadcrumb.label}}</a>\n      <a ng-show="breadcrumb.type == \'group\'" ng-href="#/{{breadcrumb.type}}/{{breadcrumb.id}}">{{breadcrumb.label}}</a>\n    </li>\n  </ul>\n\n  <div class="navbar">\n    <div class="nav navbar-right">\n      <form class="navbar-form" style="display: inline-block" name="newGroupForm">\n        <div class="form-group" ng-show="newGroup">\n          <input type="text" class="form-control" placeholder="{{\'Group name\' | translate}}" ng-model="newGroup.name" maxlength="{{c8yConfig.validation.groupName.maxlength}}" required>\n        </div>\n        <div class="form-group" ng-show="newGroup">\n          <button class="btn btn-primary" ng-click="saveNewGroup(newGroup)" ng-disabled="newGroupForm.$invalid" translate>Add Group</button>\n        </div>\n      </form>\n\n      <a class="btn btn-link" ng-click="addNewGroup()">\n        <i c8y-icon="plus"></i> {{\'Add group\' | translate}}\n      </a>\n\n      <a class="btn btn-link" ng-show="currentGroup" ng-click="assignDevices()">\n        <i c8y-icon="plus"></i> {{\'Assign devices\' | translate}}\n      </a>\n\n      <c8y-refresh-btn></c8y-refresh-btn>\n    </div>\n  </div>\n\n  <div class="alert alert-warning" ng-show="items.length == 0" style="clear:both">\n    {{\'No items to display.\' | translate}}\n  </div>\n\n  <table class="table table-hover" ng-show="items.length">\n    <tr ng-repeat="i in items|filter:isGroup|orderBy:\'name\'">\n      <td style="width:30px" class="text-center">\n        <i c8y-icon="folder-open"></i>\n      </td>\n\n      <td class="interact word-break" ng-click="drillDown(i)">\n        {{i.name}}\n        <small class="text-muted" style="margin-right:10px"><strong translate>Number of children:</strong> {{i.childAssets.references.length + i.childDevices.references.length}}</small>\n      </td>\n\n      <td class="text-center">\n        &nbsp;\n      </td>\n\n      <td class="text-right">\n        <a href="" class="btn btn-xs btn-danger showOnHover" title="{{\'Remove\' | translate}}" ng-click="onClickDeleteGroup(i)">\n          <i c8y-icon="times"></i>\n        </a>\n      </td>\n    </tr>\n    <tr ng-repeat="i in items|filter:isDevice|orderBy:\'name\'">\n      <td style="width:30px" class="text-center">\n        <c8y-device-status-display device="i"></c8y-device-status-display>\n      </td>\n\n      <td class="interact word-break" ng-click="goToDeviceDetails(i)">\n        {{i.name || \'Device \' + i.id}}\n        <small ng-if="deviceModel(i)" class="text-muted hidden-sm hidden-xs" style="margin-right:10px"><strong translate>Model:</strong> {{deviceModel(i)}}</small>\n        <small ng-if="deviceSerial(i)" class="text-muted hidden-sm hidden-xs"><strong translate>S/N:</strong> {{deviceSerial(i)}}</small>\n      </td>\n\n      <td class="text-right interact" ng-click="goToDeviceAlarms(i)">\n        <small class="status critical" ng-if="i.c8y_ActiveAlarmsStatus.critical">\n          {{i.c8y_ActiveAlarmsStatus.critical}} <i c8y-icon="warning"></i>\n        </small>\n        <small class="status major" ng-if="i.c8y_ActiveAlarmsStatus.major">\n          {{i.c8y_ActiveAlarmsStatus.major}} <i c8y-icon="exclamation-circle"></i>\n        </small>\n        <small class="status minor" ng-if="i.c8y_ActiveAlarmsStatus.minor">\n          {{i.c8y_ActiveAlarmsStatus.minor}} <i c8y-icon="exclamation-circle"></i>\n        </small>\n        <small class="status warning" ng-if="i.c8y_ActiveAlarmsStatus.warning">\n          {{i.c8y_ActiveAlarmsStatus.warning}} <i c8y-icon="circle"></i>\n        </small>\n      </td>\n\n      <td class="text-right">\n        <button class="btn btn-danger btn-xs showOnHover" title="{{\'Unassign device\' | translate}}" ng-click="onClickUnassignDevice(i)">\n          <i c8y-icon="times"></i>\n        </button>\n      </td>\n    </tr>\n    <tr ng-repeat="i in items|filter:isOtherItem|orderBy:\'name\'">\n      <td style="width:30px" class="text-center">\n        &nbsp;\n      </td>\n\n      <td class="interact" ng-click="goToDeviceDetails(i)">\n        {{i.name || \'Device \' + i.id}}\n        <small ng-if="deviceModel(i)" class="text-muted hidden-sm hidden-xs" style="margin-right:10px"><strong translate>Model:</strong> {{deviceModel(i)}}</small>\n        <small ng-if="deviceSerial(i)" class="text-muted hidden-sm hidden-xs"><strong translate>S/N:</strong> {{deviceSerial(i)}}</small>\n      </td>\n\n      <td class="text-center">\n        &nbsp;\n      </td>\n\n      <td class="text-right">\n        <button class="btn btn-danger btn-xs showOnHover" title="{{\'Unassign item\' | translate}}" ng-click="onClickUnassignDevice(i)">\n          <i c8y-icon="times"></i>\n        </button>\n      </td>\n    </tr>\n  </table>\n</div>\n',e.put("devicemanagement_groupsHierarchy/views/groupsList.html",n),e.put("/apps/devicemanagement/groupsHierarchy/views/groupsList.html",n)}angular.module("c8y.groupsHierarchy").run(["$templateCache",e])}();