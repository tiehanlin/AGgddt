/* devicemanagement_logViewer 8.7.2 2017-08-02T09:53:40+00:00 2e289fd803cb (hotfix/8.7.2) tip */
angular.module("c8y.logViewer",[]),function(){"use strict";function e(e,t,n,i,o,l,a,s,r,c,g){function d(){f().then(u),m()}function u(){e.filters={dateFrom:moment().subtract(1,"day").format(A),dateTo:moment().format(A),logFile:e.logTypes[0]&&e.logTypes[0].name||null,maximumLines:1e3}}function f(){return o.detail(t.deviceId).then(n.getResData).then(function(t){e.logTypes=_.map(t.c8y_SupportedLogs,function(e){return{name:e}})})}function m(e){var n=_.assign({deviceId:t.deviceId,fragmentType:"c8y_LogfileRequest",withTotalPages:!0},e);return l.list(n).then(p)}function p(t,n){e.operations&&!n||(e.operations=[]),t.forEach(function(t){e.operations.push(t)}),e.paging=t.paging}function y(t){e.paging.loading=!0;var n=t?m({pageSize:t}):e.paging.next().then(p);n.finally(function(){e.paging.loading=!1})}function h(){_.get(e.paging,"refresh")&&(e.realtimeAnimation=!1,e.refreshLoading=!0,e.paging.refresh().then(_.partialRight(p,!0)).finally(function(){e.refreshLoading=!1}),e.paging=null)}function v(e){return l.getStyle(e).icon}function L(e){return l.getStyle(e).cls}function b(e){if(e.c8y_LogfileRequest.file){var t=i.getIdFromUrl(e.c8y_LogfileRequest.file);if(t)return i.downloadAndSaveAs(t).catch(function(){r.danger(c("The file is not available!"))})}}function w(e){if("PENDING"===e.status)return l.cancel(e).then(_.partial(r.success,c("Cancelled log file request!"))).then(h)}function x(e){return s({title:c("Confirm removing log"),body:c("Do you really want to remove this log?"),status:"danger"}).then(_.partial(R,e)).finally(_.partial(q,e)).then(_.partial(r.success,c("Log file successfully removed!"))).then(h)}function R(e){if(e.c8y_LogfileRequest.file){var t=i.getIdFromUrl(e.c8y_LogfileRequest.file);if(t)return i.removeBinary(t)}}function q(e){var t={id:e.id,status:e.status,c8y_LogfileRequest:null};return l.save(t)}function T(t){F(t)&&(e.selectedLog=t)}function F(e){return e.c8y_LogfileRequest&&e.c8y_LogfileRequest.file}function D(){var n={deviceId:t.deviceId,description:c("Log file request"),c8y_LogfileRequest:{dateFrom:moment(e.filters.dateFrom).format(A),dateTo:moment(e.filters.dateTo).format(A),logFile:e.filters.logFile,searchText:e.filters.searchText||"",maximumLines:e.filters.maximumLines}};l.createWithNotifications(n).then(function(e){e.created.then(h),e.completed.then(function(e){e.status===l.status.SUCCESSFUL?(_.assign(n,e),T(n)):e.status===l.status.FAILED&&"Operation cancelled by user."!==e.failureReason&&(e.failureReason?r.danger(g('Could not load file because of reason: "{{failureReason}}"!',{failureReason:g.getString(e.failureReason)})):r.danger(c("Could not load file!")))},_.noop,function(e){_.assign(n,e),T(n)}).then(h)})}function I(e){return e&&"SUCCESSFUL"===e.status}function k(e){return e&&"PENDING"===e.status}function C(e){return e&&"FAILED"===e.status}function $(e){return I(e)||C(e)}function S(e){return e&&e.c8y_LogfileRequest&&e.c8y_LogfileRequest.file&&!!i.getIdFromUrl(e.c8y_LogfileRequest.file)}function V(e){return e.description||c("no description available")}var A="YYYY-MM-DDTHH:mm:ssZZ";e.requestLogfile=D,e.hasLogFile=F,e.selectLogfile=T,e.isBinary=S,e.download=b,e.cancel=w,e.remove=x,e.statusIcon=v,e.statusClass=L,e.isSuccessful=I,e.isPending=k,e.isFailed=C,e.isCompleted=$,e.refresh=h,e.loadNext=y,e.getOperationDesc=V,d();var B=e.$id,P="/operations/"+t.deviceId,U=a.realtimeActions();_.forOwn(U,function(t){a.addListener(B,P,t,function(t,n){if(_.has(n,"c8y_LogfileRequest")){h();var i=e.selectedLog;i&&i.id===n.id&&t===U.UPDATE&&(i.c8y_LogfileRequest=n.c8y_LogfileRequest)}})}),a.start(B,P),e.$on("$destroy",function(){a.stop(B,P),a.destroySubscription(B,P)})}e.$inject=["$scope","$routeParams","c8yBase","c8yBinary","c8yDevices","c8yDeviceControl","c8yRealtime","c8yModal","c8yAlert","gettext","gettextCatalog"],angular.module("c8y.logViewer").controller("logViewerCtrl",e)}(),function(){"use strict";function e(e,t){function n(e,t,n){var i;return i=e.deviceId,t.detailCached(i).then(n.getResData).then(function(e){return t.supportsOperation(e,"c8y_LogfileRequest")})}function i(t,i){e.when(t,_.assign(i,{showIf:["$routeParams","c8yDevices","c8yBase",n]}))}function o(e){var n,i;return e&&e.c8y_LogfileRequest&&e.c8y_LogfileRequest.file?(n=e.c8y_LogfileRequest.file,i=r.getIdFromUrl(n),i?r.downloadAsText(i):a.get(n)):s.when({data:t("Loading logfiles...")})}function l(e,t,n){return a=e,s=t,r=n,{getLogfile:o}}var a,s,r;return{$get:["$http","$q","c8yBinary",l],when:i,showIf:n}}e.$inject=["c8yViewsProvider","gettext"],angular.module("c8y.logViewer").provider("logViewer",e)}(),function(){"use strict";function e(e,t,n){function i(i,o){function l(i){e.getLogfile(i).then(function(e){o.text(e.data)}).catch(function(){t.danger(n("The file is no longer available."))})}i.$watch("selectedLog",l,!0)}return{restrict:"E",replace:!0,template:"<pre></pre>",link:i}}e.$inject=["logViewer","c8yAlert","gettext"],angular.module("c8y.logViewer").directive("c8yLogViewer",e)}(),function(){"use strict";function e(e,t){e.when("/device/:deviceId",{name:t("Logs"),templateUrl:"devicemanagement_logViewer/views/index.html",icon:"file-text-o"})}angular.module("c8y.logViewer").config(["logViewerProvider","gettext",e])}(),function(){"use strict";function e(e){var t;t='<div class="log-viewer" ng-controller="logViewerCtrl">\n  <div class="clearfix">\n    <c8y-refresh-btn class="pull-right"></c8y-refresh-btn>\n  </div>\n  <div style="margin-bottom: 10px">\n    <form name="logRequestForm" class="form">\n      <c8y-date-time-picker ng-model="filters.dateFrom" placeholder="{{\'From`date`\' | translate}}" max-date="filters.dateTo" style="margin-right: 15px; display: inline-block"></c8y-date-time-picker>\n      <c8y-date-time-picker ng-model="filters.dateTo" placeholder="{{\'To`date`\' | translate}}" min-date="filters.dateFrom" style="margin-right: 15px; display: inline-block"></c8y-date-time-picker>\n      <ui-select ng-model="filters.logFile" style="display: inline-block; width: 200px; margin-right: 15px; height: 34px; vertical-align: middle" uib-tooltip="{{\'Type of log\' | translate}}" required>\n        <ui-select-match placeholder="{{\'Type of log\' | translate}}">{{$select.selected.name}}</ui-select-match>\n        <ui-select-choices repeat="logType.name as logType in logTypes | filter: $select.search | orderBy:\'name\'">\n          <div ng-bind-html="logType.name | highlight: $select.search"></div>\n        </ui-select-choices>\n      </ui-select>\n      <div class="form-group" style="display: inline-block; margin-right: 15px; vertical-align:middle; margin-bottom: 0">\n        <input class="form-control" placeholder="{{\'Filter by text\' | translate}}" ng-model="filters.searchText" uib-tooltip="{{\'Filter by text\' | translate}}" ng-trim="false"/>\n      </div>\n      <div class="form-group" style="display: inline-block; margin-right: 15px">\n        <span translate>Last lines to display</span>\n        <input type="number" class="form-control" style="width: 100px; margin-left: 5px; margin-right: 5px; display:inline-block" ng-model="filters.maximumLines" required/>\n      </div>\n      <div class="form-group" style="display: inline-block; margin-right: 15px">\n        <button class="btn btn-primary" ng-disabled="logRequestForm.$invalid" ng-click="requestLogfile()" translate>Request log</button>\n      </div>\n    </form>\n  </div>\n\n  <div class="alert alert-warning" ng-hide="operations" translate>\n    No logs found.\n  </div>\n\n  <table class="table">\n    <tr ng-class="{\'realtime-animation-list\': realtimeAnimation, \'active\': op === selectedLog}" ng-repeat="op in operations | orderBy:\'-creationTime\'">\n      <td style="width: 30px" class="text-center">\n        <i c8y-icon="{{statusIcon(op)}}" ng-class="statusClass(op)" uib-tooltip="{{op.status | translate}}"></i>\n      </td>\n      <td ng-class="{\'interact\': hasLogFile(op)}" ng-click="selectLogfile(op)">\n        <span ng-bind="getOperationDesc(op)"></span>\n        <a class="text-muted" ng-href="#/device/{{op.deviceId}}"><small><i c8y-icon="cog"></i>{{\'Device\' | translate}} {{op.deviceId}}</small></a>\n      </td>\n      <td>\n        <small class="text-muted">\n          <i c8y-icon="clock-o"></i> {{op.c8y_LogfileRequest.dateFrom|absoluteDate}} &ndash; {{op.c8y_LogfileRequest.dateTo|absoluteDate}}\n        </small>\n      </td>\n      <td>\n        <button class="btn btn-danger btn-xs showOnHover pull-right" uib-tooltip="{{\'Cancel operation\' | translate}}" ng-click="cancel(op)" ng-if="isPending(op)">\n          <i c8y-icon="times"></i>\n        </button>\n        <button class="btn btn-danger btn-xs showOnHover pull-right" uib-tooltip="{{\'Remove log\' | translate}}" ng-click="remove(op)" ng-if="isSuccessful(op)">\n          <i c8y-icon="times"></i>\n        </button>\n        <button ng-show="isBinary(op)" class="btn btn-primary btn-xs showOnHover pull-right" uib-tooltip="{{\'Download\' | translate}}" ng-click="download(op)">\n          <i c8y-icon="download"></i>\n        </button>\n        <a ng-hide="isBinary(op) || !op.c8y_LogfileRequest.file" class="btn btn-primary btn-xs showOnHover pull-right" uib-tooltip="{{\'Download\' | translate}}" ng-href="{{op.c8y_LogfileRequest.file}}" download>\n          <i c8y-icon="download"></i>\n        </a>\n      </td>\n    </tr>\n  </table>\n\n  <c8y-load-more change-page-size></c8y-load-more>\n\n  <div ng-show="isSuccessful(selectedLog)">\n    <h5>\n      <i c8y-icon="bars"></i> <translate>Details</translate>\n    </h5>\n    <table class="table table-condensed table-borderless">\n      <tr ng-show="selectedLog.c8y_LogfileRequest.dateFrom">\n        <th style="width: 175px" translate>Date from</th>\n        <td ng-bind="selectedLog.c8y_LogfileRequest.dateFrom|absoluteDate"></td>\n      </tr>\n      <tr ng-show="selectedLog.c8y_LogfileRequest.dateTo">\n        <th style="width: 175px" translate>Date to</th>\n        <td ng-bind="selectedLog.c8y_LogfileRequest.dateTo | absoluteDate"></td>\n      </tr>\n      <tr ng-show="selectedLog.c8y_LogfileRequest.logFile">\n        <th style="width: 175px" translate>Type of log</th>\n        <td ng-bind="selectedLog.c8y_LogfileRequest.logFile"></td>\n      </tr>\n      <tr ng-show="selectedLog.c8y_LogfileRequest.searchText">\n        <th style="width: 175px" translate>Filtered by text</th>\n        <td><tt style="white-space: pre" ng-bind="selectedLog.c8y_LogfileRequest.searchText"></tt></td>\n      </tr>\n      <tr ng-show="selectedLog.c8y_LogfileRequest.maximumLines">\n        <th style="width: 175px" translate>Last N lines</th>\n        <td ng-bind="selectedLog.c8y_LogfileRequest.maximumLines"></td>\n      </tr>\n    </table>\n    <c8y-log-viewer></c8y-log-viewer>\n  </div>\n</div>\n',e.put("devicemanagement_logViewer/views/index.html",t),e.put("/apps/devicemanagement/logViewer/views/index.html",t)}angular.module("c8y.logViewer").run(["$templateCache",e])}();