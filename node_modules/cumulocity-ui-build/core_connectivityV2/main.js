/* core_connectivityV2 8.7.2 2017-08-02T09:54:04+00:00 e22b35b1d531 (hotfix/8.7.2) tip */
!function(){"use strict";function t(t,n){function e(t,e,s,i,a,o){function r(n){return u=n.devicePromise,_.get(u,"c8y_Mobile.iccid")?t.when():t.reject()}function c(){return _.get(u,"c8y_Mobile.c8y_IsConnectivity")?t.when():a.getTerminalDetails(d,{},{},{silentError:!0}).then(function(){return _.set(u,"c8y_Mobile.c8y_IsConnectivity",{}),o.save(u)})}function l(){return a.getSource(d).then(function(e){var i=[];if(_.get(e,"url")){var a={text:n("SIM details"),action:function(){window.open(e.url,"_blank")}};i.push(a)}return t.when(_.forEach(i,s.addAction))})}var u,d=e.deviceId,g=t.all({devicePromise:o.detailCached(d).then(i.getResData)}),v=a.safePing();return g.then(r).then(v).then(c).then(l).then(_.constant(!0)).catch(_.constant(!1))}e.$inject=["$q","$routeParams","c8yActions","c8yBase","c8yConnectivity","c8yDevices"],t.when("/device/:deviceId",{template:"<c8y-connectivity-v2 />",name:n("Connectivity"),icon:"plug",showIfPermissions:{anyRole:["ROLE_CONNECTIVITY_READ"]},showIf:e})}t.$inject=["c8yViewsProvider","gettext"],angular.module("c8y.connectivityV2",[]).config(t)}(),function(){"use strict";function t(t,n,e,s){function i(){a().then(function(t){l.available=t})}function a(){return o().then(c).then(_.constant(!0)).catch(_.constant(!1))}function o(){return e.safePing()}function r(){l.available=!1,l.commonData=c().then(function(t){return n(function(){l.available=!0},100),t})}function c(){return _.set(l,"commonData.currentMonthDataUsage",e.getTerminalDataUsage(t.deviceId,{},u)),_.get(l,"commonData.currentMonthDataUsage")}var l=this,u=s.getThisMonth();_.assign(l,{$onInit:i,available:!1,reload:r})}t.$inject=["$routeParams","$timeout","c8yConnectivity","connectivityService"],angular.module("c8y.connectivityV2").component("c8yConnectivityV2",{controller:t,controllerAs:"vm",templateUrl:"core_connectivityV2/connectivityV2.html"})}(),function(){"use strict";function t(t,n,e,s){function i(t){if(t.dateFrom){var n=t.dateFrom;t.dateFrom=moment(n).format("YYYY-MM-DD"),t.cycleStartDate=moment(n).format("YYYY-MM-DD")}return t.dateTo?t.dateTo=moment(t.dateTo).format("YYYY-MM-DD"):t.dateTo=moment().format("YYYY-MM-DD"),t}function a(){var n=t.monthFilter();return _.unset(n,"dataTo"),i(n)}function o(){var n=t.monthFilter({},1);return i(n)}function r(t,n,s){var i="";if(!_.isUndefined(s)){var a={today:t.dateTo,thisMonthStart:t.dateFrom,lastMonthStart:n.dateFrom,lastMonthEnd:n.dateTo,lastMonthUsage:s};i=e.getString("Usage this month to date ({{thisMonthStart}} - {{today}})\nUsage for last month ({{lastMonthStart}} - {{lastMonthEnd}}): {{lastMonthUsage}}",a)}return i}function c(t,n){var e=t?_.reduce(t,function(t,e){return t+_.get(e,n)},0).toFixed(3):0;return e>0?e:0}function l(){return n.hasAnyRole(["ROLE_CONNECTIVITY_ADMIN"])}var u={getThisMonth:a,getLastMonth:o,getUsageTooltip:r,processUsageData:c,isAdmin:l};return u}t.$inject=["c8yBase","c8yPermissions","gettextCatalog","gettext"],angular.module("c8y.connectivityV2").factory("connectivityService",t)}(),function(){"use strict";function t(t,n,e,s,i,a,o,r){function c(){_.assign(N,{setStatus:y,statusMap:k,getLastMonthSmsUsageTooltip:D,getDataUsageTooltip:C,getVoiceUsageTooltip:L,setSimStatus:E})}function l(t){_.get(t,"available.currentValue")&&u()}function u(){d(),v(),h(),S(),U(),V(),A(),x(),Y()}function d(){return s.getStatuses().then(function(t){_.set(N,"statusMap.statuses",g(t.statuses))})}function g(t){return _.map(t,function(t){return{status:t.status,readOnly:t.readOnly,text:r(n("humanize")(t.status).replace("NAME","").trim())}})}function v(){o.isAdmin().then(m)}function m(t){N.isAdmin=t}function h(){return s.getTerminalDetails(t.deviceId).then(f).then(b).then(p)}function f(t){var n=r(t.inSession?"Yes":"No");return N.session=_.assign(N.session,t,{inSession:n,fixedIpAddress:t.fixedIpAddress||"-"}),N.currentStatus=_.get(t,"status.value"),N.session}function y(){var t=_.find(k.statuses,function(t){return t.status===N.session.status});N.currentStatus=t.status}function b(){N.statusIcon=_.get(N.statusMap,"icons["+_.get(N,"session.status.activity")+"].icon")}function p(){N.statusClass=_.get(N.statusMap,"icons["+_.get(N,"session.status.activity")+"].class")}function S(){return s.getTerminalSmsUsage(t.deviceId,{},j).then(M)}function M(t){return N.session=_.assign(N.session,{lastMonthSmsUsage:t.billings?t.billings.length:0}),N.session}function D(){return o.getUsageTooltip(R,j,_.get(N,"session.lastMonthSmsUsage"))}function U(){return s.getTerminalSmsUsage(t.deviceId,{},R).then(T)}function T(t){return N.session=_.assign(N.session,{currentMonthSmsUsage:t.billings?t.billings.length:0}),N.session}function V(){return s.getTerminalDataUsage(t.deviceId,{},j).then(I)}function I(t){var n=o.processUsageData(t.billings,"volume");return N.session=_.assign(N.session,{lastMonthDataUsage:n}),N.session}function C(){return o.getUsageTooltip(R,j,_.get(N,"session.lastMonthDataUsage"))}function A(){return(_.get(N,"commonData.currentMonthDataUsage")||s.getTerminalDataUsage(t.deviceId,{},R)).then(w)}function w(t){var n=o.processUsageData(t.billings,"volume");return N.session=_.assign(N.session,{currentMonthDataUsage:n}),N.session}function x(){return s.getTerminalVoiceUsage(t.deviceId,{},j).then($)}function $(t){var n=o.processUsageData(t.billings,"duration");return N.session=_.assign(N.session,{lastMonthVoiceUsage:n}),N.session}function L(){return o.getUsageTooltip(R,j,_.get(N,"session.lastMonthVoiceUsage"))}function Y(){return s.getTerminalVoiceUsage(t.deviceId,{},j).then(P)}function P(t){var n=o.processUsageData(t.billings,"duration");return N.session=_.assign(N.session,{currentMonthVoiceUsage:n}),N.session}function E(n){return s.setTerminalSimStatusV2(t.deviceId,{status:n}).then(function(t){N.currentStatus=t.status}).then(N.onReload).then(F)}function F(){var t=r("SIM status successfully changed");return a.success(t)}var N=this,k={icons:{OPERATING:{icon:"check-circle",class:"statusOk"},SUSPENDED:{icon:"exclamation-circle",class:"statusNok"},MAINTENANCE:{icon:"wrench",class:"statusAlert"}}},R=o.getThisMonth(),j=o.getLastMonth();_.assign(N,{$onInit:c,$onChanges:l})}t.$inject=["$routeParams","$filter","c8yBase","c8yConnectivity","c8yPermissions","c8yAlert","connectivityService","gettext"],angular.module("c8y.connectivityV2").component("c8yConnectivityStatus",{controller:t,controllerAs:"vm",templateUrl:"core_connectivityV2/status.html",bindings:{available:"<",onReload:"&",commonData:"<?"}})}(),function(){"use strict";function t(t,n){function e(t){_.get(t,"available.currentValue")&&s()}function s(){return n.getTerminalAuditLogs(t.deviceId).then(i)}function i(t){return a.auditLogs=t.entries,a.auditLogs}var a=this;_.assign(a,{$onChanges:e})}t.$inject=["$routeParams","c8yConnectivity"],angular.module("c8y.connectivityV2").component("c8yConnectivityAuditLogs",{controller:t,controllerAs:"vm",templateUrl:"core_connectivityV2/auditLogs.html",bindings:{available:"<"}})}(),function(){"use strict";function t(t,n,e,s,i,a,o){function r(t){_.get(t,"available.currentValue")&&(u(),c())}function c(){a.isAdmin().then(l)}function l(t){h.isAdmin=t}function u(){return e.getSms(n.deviceId,{},f).then(d)}function d(t){return h.smss=t.entries,h.smss}function g(){var t=o("SMS successfully sent");return h.message.text="",s.success(t)}function v(t){return e.sendSms(n.deviceId,t).then(u).then(g)}function m(t){return i.validationHints(t,y)}var h=this,f=a.getThisMonth(),y={required:o("This field is required!")},b="messageForm";t.invalid=_.bind(i.invalid,i,t.forms,b),_.assign(h,{$onChanges:r,sendSms:v,validationHints:m})}t.$inject=["$scope","$routeParams","c8yConnectivity","c8yAlert","c8yBase","connectivityService","gettext"],angular.module("c8y.connectivityV2").component("c8yConnectivitySms",{controller:t,controllerAs:"vm",templateUrl:"core_connectivityV2/sms.html",bindings:{available:"<"}})}(),function(){"use strict";function t(t,n,e){function s(t){_.get(t,"available.currentValue")&&i()}function i(){return(_.get(o,"commonData.currentMonthDataUsage")||n.getTerminalDataUsage(t.deviceId,{},r)).then(a)}function a(t){return o.sessions=t.billings,o.sessions}var o=this,r=e.getThisMonth();_.assign(o,{$onChanges:s})}t.$inject=["$routeParams","c8yConnectivity","connectivityService"],angular.module("c8y.connectivityV2").component("c8yConnectivitySessions",{controller:t,controllerAs:"vm",templateUrl:"core_connectivityV2/sessions.html",bindings:{available:"<",commonData:"<?"}})}(),function(){"use strict";function t(t){var n;n='<div ng-show="vm.auditLogs.length > 0">\n  <div class="panel-heading">\r\n    <i c8y-icon="book"></i>\r\n    {{\'Audit logs\' | translate }}\r\n  </div>\r\n\n    <div class="panel-body">\r\n      <table class="table">\r\n        <thead>\r\n          <tr>\r\n            <th translate>Changed</th>\r\n            <th translate>Previous value</th>\n            <th translate>Current value</th>\n            <th translate>When</th>\r\n            <th translate>Who</th>\r\n            <th translate>Status</th>\r\n          </tr>\r\n        </thead>\r\n        <tbody>\r\n          <tr ng-repeat="auditLog in vm.auditLogs">\n            <td ng-bind="auditLog.change"></td>\n            <td ng-bind="auditLog.from"></td>\n            <td ng-bind="auditLog.to"></td>\n            <td ng-bind="auditLog.dateTime | absoluteDate"></td>\n            <td ng-bind="auditLog.triggeredBy"></td>\n            <td ng-bind="auditLog.status"></td>\n          </tr>\r\n        </tbody>\r\n      </table>\r\n    </div>\r\n  </div>\r\n',t.put("core_connectivityV2/auditLogs.html",n),t.put("/apps/core/connectivityV2/auditLogs.html",n),n='<div class="connectivity-plugin">\n  <div class="panel panel-clean">\r\n\r\n    <div class="clearfix">\r\n      <button class="btn btn-link pull-right" ng-disabled="loading" ng-click="vm.reload()">\n        <i c8y-icon="refresh"></i>\r\n        <translate>Reload</translate>\r\n      </button>\r\n    </div>\r\n\r\n    <c8y-connectivity-status available="vm.available" on-reload="vm.reload()" common-data="vm.commonData"></c8y-connectivity-status>\n    <c8y-connectivity-sms available="vm.available"></c8y-connectivity-sms>\n    <c8y-connectivity-sessions available="vm.available" common-data="vm.commonData"></c8y-connectivity-sessions>\n    <c8y-connectivity-audit-logs available="vm.available"></c8y-connectivity-audit-logs>\n\r\n  </div>\r\n</div>\r\n',t.put("core_connectivityV2/connectivityV2.html",n),t.put("/apps/core/connectivityV2/connectivityV2.html",n),n='<div ng-show="vm.sessions.length > 0">\n  <div class="panel-heading">\r\n    <i c8y-icon="exchange"></i>\r\n    {{\'Sessions\' | translate }}\r\n  </div>\r\n\r\n  <div class="panel-body">\r\n    <table class="table">\r\n      <thead>\r\n        <tr>\r\n          <th translate>Customer</th>\n          <th translate>Started</th>\r\n          <th translate>Duration</th>\r\n          <th translate>Data usage (KB)</th>\r\n        </tr>\r\n      </thead>\r\n      <tbody>\r\n        <tr ng-repeat="session in vm.sessions">\n          <td ng-bind="session.customer"></td>\n          <td ng-bind="session.sessionStartTime | absoluteDate"></td>\n          <td ng-bind="session.duration | duration"></td>\n          <td ng-bind="session.volume"></td>\n        </tr>\r\n      </tbody>\r\n    </table>\r\n  </div>\r\n</div>\r\n',t.put("core_connectivityV2/sessions.html",n),t.put("/apps/core/connectivityV2/sessions.html",n),n='<div class="panel-heading" ng-show="vm.smss.length > 0 || vm.isAdmin">\n  <i c8y-icon="envelope"></i>\r\n  {{\'SMS\' | translate }}\r\n</div>\r\n\r\n<div class="panel-body">\r\n  <table class="table" ng-show="vm.smss.length > 0">\n    <thead>\r\n      <tr>\r\n        <th translate>SMS ID</th>\r\n        <th translate>Date sent</th>\r\n        <th translate>Date received</th>\r\n        <th translate>Message text</th>\r\n        <th translate>Sent from</th>\r\n        <th translate>Sent to</th>\r\n        <th translate>Status</th>\r\n        <th translate>Message type</th>\r\n      </tr>\r\n    </thead>\r\n    <tbody>\r\n      <tr ng-repeat="sms in vm.smss">\n        <td ng-bind="sms.smsId"></td>\n        <td ng-bind="sms.dateSent | absoluteDate"></td>\n        <td ng-bind="sms.dateReceived | absoluteDate"></td>\n        <td ng-bind="sms.text"></td>\n        <td ng-bind="sms.from"></td>\n        <td ng-bind="sms.to"></td>\n        <td ng-bind="sms.status"></td>\n        <td ng-bind="sms.type"></td>\n      </tr>\r\n    </tbody>\r\n  </table>\r\n  <form name="forms.messageForm" ng-if="vm.isAdmin">\n    <div class="row" ng-class="{\'has-error\': invalid(\'mText\')}" uib-tooltip="{{vm.validationHints(forms.messageForm.mText)}}">\n      <textarea required ng-model="vm.message.text" name="mText" class="form-control form-group" rows="3"></textarea>\n    </div>\r\n\r\n    <div class="row">\r\n      <button ng-disabled="!vm.message.text" class="btn btn-primary" translate ng-click="vm.sendSms(vm.message)">\n        Send SMS\n      </button>\n    </div>\r\n  </form>\r\n</div>\r\n',t.put("core_connectivityV2/sms.html",n),t.put("/apps/core/connectivityV2/sms.html",n),n='<div class="panel-heading">\r\n  <i c8y-icon="mobile"></i>\r\n  <translate>Status</translate>\r\n</div>\r\n\r\n<div class="panel-body">\r\n  <form name="forms.terminalForm">\r\n    <div class="row">\r\n      <div class="form-group col-lg-6">\r\n        <label class="noicon" translate>In session</label>\r\n        <h4 ng-bind="vm.session.inSession | translate"></h4>\n      </div>\r\n      <div ng-show="vm.session.inSession === \'Yes\'">\n        <div class="form-group col-lg-3">\r\n          <label class="noicon" translate>Session start</label>\r\n          <h4 ng-bind="vm.session.dateSessionStarted | absoluteDate"></h4>\n        </div>\r\n        <div class="form-group col-lg-3">\r\n          <label class="noicon" translate>Session IP address</label>\r\n          <h4 ng-bind="vm.session.ipAddress"></h4>\n        </div>\r\n      </div>\r\n    </div>\r\n    <div class="row">\r\n      <div class="form-group col-lg-3">\r\n        <label class="noicon" translate>ICCID</label>\r\n        <h4 ng-bind="vm.session.iccid"></h4>\n      </div>\r\n      <div class="form-group col-lg-3">\r\n      </div>\r\n      <div class="form-group col-lg-6">\r\n        <label class="noicon" translate>Data usage (MB)</label>\r\n        <h4 class="wide-linebreak-tooltip">\r\n          {{vm.session.currentMonthDataUsage}}\n          <i c8y-icon="question-circle" uib-tooltip="{{vm.getDataUsageTooltip()}}" tooltip-placement="right"></i>\n        </h4>\r\n      </div>\r\n    </div>\r\n    <div class="row">\r\n      <div class="col-lg-6">\r\n        <label translate>SIM status</label>\r\n        <div class="row">\r\n          <div class="col-lg-6">\r\n            <select class="form-control" ng-model="vm.currentStatus" ng-disabled="!vm.isAdmin" ng-change="vm.setSimStatus(vm.currentStatus)">\n              <option ng-repeat="status in vm.statusMap.statuses" ng-disabled="status.readOnly" ng-bind="status.text" ng-selected="status.status === currentStatus" value="{{status.status}}" translate>\n              </option>\r\n            </select>\r\n          </div>\r\n          <h4 class="col-lg-6"><i c8y-icon="{{vm.statusIcon}}" ng-class="vm.statusClass"></i></h4>\n        </div>\r\n      </div>\r\n      <div class="form-group col-lg-6">\r\n        <label class="noicon" translate>SMS usage</label>\r\n        <h4 class="wide-linebreak-tooltip">\r\n          {{vm.session.currentMonthSmsUsage}}\n          <i c8y-icon="question-circle" uib-tooltip="{{vm.getLastMonthSmsUsageTooltip()}}" tooltip-placement="right"></i>\n        </h4>\r\n      </div>\r\n    </div>\r\n    <div class="row">\r\n      <div class="form-group col-lg-6">\r\n        <label class="noicon" translate>Fixed IP address</label>\r\n        <h4 ng-bind="vm.session.fixedIpAddress | translate"></h4>\n      </div>\r\n      <div class="form-group col-lg-6">\r\n        <label class="noicon" translate>Voice usage</label>\r\n        <h4 class="wide-linebreak-tooltip">\r\n          {{vm.session.currentMonthVoiceUsage}}\n          <i c8y-icon="question-circle" uib-tooltip="{{vm.getVoiceUsageTooltip()}}" tooltip-placement="right"></i>\n        </h4>\r\n      </div>\r\n    </div>\r\n  </form>\r\n</div>\r\n',t.put("core_connectivityV2/status.html",n),t.put("/apps/core/connectivityV2/status.html",n)}angular.module("c8y.connectivityV2").run(["$templateCache",t])}();