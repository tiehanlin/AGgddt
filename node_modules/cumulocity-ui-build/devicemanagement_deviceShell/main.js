/* devicemanagement_deviceShell 8.7.2 2017-08-02T09:53:39+00:00 2e289fd803cb (hotfix/8.7.2) tip */
angular.module("c8y.deviceShell",[]).config(["c8yViewsProvider","gettext",function(e,n){var t="gamepad",a=n("Shell"),i="/device/:deviceId",c="devicemanagement_deviceShell/views/";e.when(i,{name:a,icon:t,templateUrl:c+"index.html",showIf:["$routeParams","c8yBase","c8yDevices",function(e,n,t){return t.detailCached(e.deviceId).then(n.getResData).then(function(e){return t.supportsOperation(e,"c8y_Command")})}]})}]),function(){"use strict";function e(e,n,t,a,i,c,s,l,o,d,r){function m(){u(),v(),h()}function u(){e.command={text:""}}function v(){p().then(g)}function p(){var e={deviceId:n.deviceId,pageSize:H,fragmentType:"c8y_Command",revert:!0};return c.list(i.timeOrderFilter(e))}function g(n){e.operations=n}function h(){s.canSendCommandsViaSMS().then(function(n){e.smsEnabled=n})}function f(e){return b(e,!0)}function b(n,t){e.sendingCommand=!0;var a=y(n,t);return c.createWithNotifications(a).then(function(e){return e.created.then(_.partial(S,a)),e.completed.then(_.partial(x,a),_.noop,_.partial(x,a)),e.created}).finally(function(){n.text="",e.sendingCommand=!1})}function y(e,t){return{deviceId:n.deviceId,description:r("Execute shell command")+(e.name?": "+e.name:""),deliveryType:t?"SMS":void 0,c8y_Command:{text:e.text}}}function S(e,n){c.detail(n).then(i.getResData).then(function(n){o.success(r("Command has been sent!")),_.assign(e,n),T(e)})}function x(e,n){o.success(r("Command's status has been updated!")),_.assign(e,n)}function T(n){e.operations.push(n),C(n)}function C(e){B.length=0,w(e)}function w(e){if(k(e)){var n=B.indexOf(e);B.splice(n,1)}else B.push(e)}function k(e){return B.indexOf(e)>-1}function E(e){return e&&c.getStyle(e)&&c.getStyle(e).cls}function M(e){return e&&c.getStyle(e)&&c.getStyle(e).icon}function I(){t.url(D())}function D(){return"/device/"+n.deviceId+"/control?fragmentType=c8y_Command"}function P(){l({templateUrl:"devicemanagement_deviceShell/views/commandTemplates.html",controller:"commandTemplatesCtrl"}).then(function(n){"USE"===n.action?(e.command.name=n.commandTemplate.name,e.command.text=n.commandTemplate.text,F.refresh()):"EXECUTE"===n.action&&b(n.commandTemplate,n.useSMS)})}function $(e){return Math.min(10,e?e.split(/\r\n|\r|\n/).length:1)}function O(){d.detail(n.deviceId).then(i.getResData).then(R)}function R(n){e.device=n,e.transp=U()}function U(){var n=e.device,t=(n||{})[W],a=t&&t[X],i=_.find(L,{val:G});return a&&(i=_.find(L,{val:a})),i}function N(n){if(!n)return!0;if(e.changingTransportMode)return r("An operation to change transport mode is currently in progress.");if("sms"===n.val){var t=e.device,a=(t||{}).c8y_Mobile||{},i=a.msisdn;if(!i)return r("The MSISDN is not defined.")}return n.val===U().val&&r("This is currently defined communication mode")}function V(n){var t=e.device,a=_.cloneDeep(t[W]||{}),i={deviceId:t.id};i[W]=a,a[X]=n.val,e.changingTransportMode=!0,c.createWithNotifications(i).then(function(e){e.created.then(function(){o.info(r("Operation to change communication mode successfully created!"))},A),e.completed.then(function(){O(),o.success(r("Communication mode successfully changed!"))}).finally(A)})}function A(){e.changingTransportMode=!1}var B=[],F={},H=3,G="IP",L=[{val:"IP",display:"IP"},{val:"SMS",display:"SMS"}],W="c8y_CommunicationMode",X="mode";O(),e.canChangeTransport=N,e.changeTransport=V,e.execute=b,e.executeSMS=f,e.transportMode=U,e.transportModes=L,e.toggle=w,e.isOpen=k,e.statusClass=E,e.statusIcon=M,e.cancel=c.cancel,e.viewHistory=I,e.getViewHistoryLink=D,e.getPredefinedCommand=P,e.deviceStatus=F,e.getTextAreaRows=$,m()}angular.module("c8y.deviceShell").controller("deviceShellCtrl",["$scope","$routeParams","$location","$q","c8yBase","c8yDeviceControl","c8yDeviceShell","c8yModal","c8yAlert","c8yInventory","gettext",e])}(),angular.module("c8y.deviceShell").controller("commandTemplatesCtrl",["$scope","$routeParams","$uibModalInstance","c8yBase","c8yDevices","c8yDeviceShell","gettextCatalog",function(e,n,t,a,i,c,s){"use strict";function l(){o(),u()}function o(){d(n.deviceId).then(m)}function d(e){return i.detailCached(e).then(a.getResData).then(r).then(c.getCommandTemplatesForDeviceType)}function r(e){return e.type}function m(e){h.length=0,_.forEach(e,function(e){h.push({name:s.getString(e.name),text:e.command,category:s.getString(e.category)})})}function u(){c.canSendCommandsViaSMS().then(function(n){e.smsEnabled=n})}function v(){e.result.action="USE",t.close(e.result)}function p(n){e.result.action="EXECUTE",e.result.useSMS=n||!1,t.close(e.result)}function g(){p(!0)}var h=[],f={action:null,commandTemplate:null};e.commandTemplates=h,e.result=f,e.use=v,e.execute=p,e.executeSMS=g,e.cancel=t.dismiss,l()}]),angular.module("c8y.deviceShell").controller("deviceStatusCtrl",["$scope","$routeParams","c8yBase","c8yDevices","c8yDeviceStatus","gettext",function(e,n,t,a,i,c){"use strict";function s(){return e.refreshing=!0,a.detail(n.deviceId).then(t.getResData).then(l).finally(function(){e.refreshing=!1})}function l(n){e.device=n}function o(){return i.isDeviceAvailable(e.device)}function d(){return c(o(e.device)?"Device is online":"Device is offline")}e.refresh=s,e.getStatus=d,e.isOnline=o,s()}]),angular.module("c8y.deviceShell").directive("deviceStatus",function(){"use strict";return{restrict:"E",templateUrl:"devicemanagement_deviceShell/views/deviceStatus.html",controller:"deviceStatusCtrl",scope:{device:"=",isOnline:"=",refresh:"="}}}),function(){"use strict";function e(e){var n;n='\n<div class="card">\n  <div class="card-header">\n    <h4 class="card-title"><i c8y-icon="terminal"></i> {{\'Command\' | translate}}</h4>\n    <div class="flex-item-right">\n      <device-status device="deviceStatus.device" is-online="deviceStatus.isOnline" refresh="deviceStatus.refresh"></device-status>\n    </div>\n  </div>\n  <hr>\n  <div class="card-block">\n    <textarea class="form-control" rows="1" ng-model="command.text"></textarea>\n  </div>\n  <div class="card-footer separator">\n    <button type="button" class="btn btn-primary" ng-click="execute(command)" ng-disabled="!command.text || sendingCommand" translate="">Execute</button>\n    <button type="button" class="btn btn-primary" ng-click="executeSMS(command)" ng-disabled="!smsEnabled || !command.text || sendingCommand" translate="">Execute (SMS)</button>\n  </div>\n</div>\n',e.put("devicemanagement_deviceShell/views/command.html",n),e.put("/apps/devicemanagement/deviceShell/views/command.html",n),n='<div class="modal-header text-center">\n  <h3 translate style="margin-bottom: 10px">Select a predefined command</h3>\n  <form class="commandTemplatesSearchForm">\n    <div class="input-group input-group-search">\n      <input type="search" class="form-control" placeholder="{{\'Search command by name or text\' | translate}}" ng-model="commandsFilter.text">\n      <span class="input-group-addon">\n        <i c8y-icon="search"></i>\n      </span>\n    </div>\n  </form>\n</div>\n<div class="modal-inner-scroll">\n  <div class="command-templates-list list-group">\n    <a href ng-repeat="commandTemplate in commandTemplates | filter:commandsFilter.text" class="list-group-item" ng-class="{\'active\': result.commandTemplate === commandTemplate}" ng-click="result.commandTemplate = commandTemplate">\n      <span class="list-group-item-heading">{{commandTemplate.name}} <span ng-show="commandTemplate.category" class="label label-info pull-right">{{commandTemplate.category}}</span></span>\n      <br><span class="list-group-item-text"><small ng-class="{\'text-muted\': result.commandTemplate != commandTemplate}">{{commandTemplate.text}}</small></span>\n    </a>\n  </div>\n</div>\n<div class="modal-footer">\n  <button type="button" class="btn btn-default" ng-click="cancel()" translate="">Cancel</button>\n  <button type="button" class="btn btn-primary" ng-click="use()" ng-disabled="!result.commandTemplate" translate="">Use</button>\n  <button type="button" class="btn btn-primary" ng-click="execute()" ng-disabled="!result.commandTemplate" translate="">Execute</button>\n  <button type="button" class="btn btn-primary" ng-click="executeSMS()" ng-disabled="!result.commandTemplate || !smsEnabled" translate="">Execute (SMS)</button>\n</div>\n',e.put("devicemanagement_deviceShell/views/commandTemplates.html",n),e.put("/apps/devicemanagement/deviceShell/views/commandTemplates.html",n),n='\n<small class="text-right">\n  {{getStatus() | translate}}\n  <button class="btn btn-link btn-xs" style="padding:0" ng-click="refresh()" title="{{\'Refresh device status\' | translate}}">\n    <i c8y-icon="refresh" ng-class="{\'fa-spin\': refreshing}"></i>\n  </button>\n</small>\n',e.put("devicemanagement_deviceShell/views/deviceStatus.html",n),e.put("/apps/devicemanagement/deviceShell/views/deviceStatus.html",n),n='<div ng-controller="deviceShellCtrl">\n  <div class="c8y-toolbar-spacer page-toolbar">\n    <div class="c8y-toolbar navbar navbar-default">\n\n      <div class="navbar-header">\n        <button type="button" class="navbar-toggle collapsed" ng-click="isPageToolbarExpanded = !isPageToolbarExpanded" aria-expanded="false">\n          <span class="sr-only">Toggle Toolbar</span>\n          <span class="icon-bar"></span>\n          <span class="icon-bar"></span>\n          <span class="icon-bar"></span>\n        </button>\n      </div>\n\n      <div id="page-toolbar" class="navbar-collapse text-center collapse" uib-collapse="!isPageToolbarExpanded" aria-expanded="false" aria-hidden="true" style="height: 0px">\n\n        <ul class="nav navbar-nav navbar-right">\n          <li>\n            <a ng-href="#{{getViewHistoryLink()}}" class="btn btn-link pull-right">\n              <i c8y-icon="history"></i> {{\'View history\' | translate}}\n            </a>\n          </li>\n          <li>\n            <button type="button" class="btn btn-link" ng-click="getPredefinedCommand()">\n              <i c8y-icon="terminal"></i> {{\'Get predefined command\' | translate}}\n            </button>\n          </li>\n        </ul>\n      </div>\n    </div>\n  </div>\n\n  <div class="row">\n    <div class="col-md-6" ng-include="\'devicemanagement_deviceShell/views/list.html\'"></div>\n    <div class="col-md-6" ng-include="\'devicemanagement_deviceShell/views/command.html\'"></div>\n  </div>\n</div>\n',e.put("devicemanagement_deviceShell/views/index.html",n),e.put("/apps/devicemanagement/deviceShell/views/index.html",n),n='<div class="timeline-list list-condensed" style="margin-bottom: 40px">\n\n  <div class="c8y-empty-state text-left" ng-show="operations.length == 0">\n    <h1 class="c8y-icon c8y-icon-operations c8y-icon-duocolor"></h1>\n    <p>{{\'No operations have been invoked yet.\' | translate}}</p>\n  </div>\n\n  <div class="timeline-list-item flex-row" ng-class="{\'expanded\': isOpen(op)}" ng-repeat="op in operations | orderBy:\'creationTime\'" ng-click="toggle(op)">\n    <small class="timeline-item-date text-right ng-binding">\n      {{op.creationTime|absoluteDate}}\n    </small>\n    <div class="timeline-item-content flex-row wrap">\n      <div class="list-item-icon">\n        <i c8y-icon="{{statusIcon(op)}}" ng-class="statusClass(op)" uib-tooltip="{{op.status | translate}}"></i>\n      </div>\n      <div class="list-item-actions" ng-click="$event.stopPropagation()">\n        <button type="button" title="Expand" class="collapse-btn" ng-click="toggle(op)">\n          <i c8y-icon="chevron-down" class="fa fw fa-chevron-down"></i>\n        </button>\n      </div>\n\n      <div class="list-item-body">\n        <div class="flex-row">\n          <div>\n            {{op.status | translate}} <br class="visible-xs visible-sm">\n            <small>{{op.c8y_Command.text}}</small>\n          </div>\n          <div class="flex-item-right showOnHover" ng-click="$event.stopPropagation()" ng-if="op.status==\'PENDING\'">\n            <button class="btn btn-danger btn-xs" title="{{\'Cancel operation\' | translate}}" ng-click="cancel(op)">\n              <i c8y-icon="times"></i>\n            </button>\n          </div>\n        </div>\n      </div>\n\n      <div class="collapse" style="width: 100%" uib-collapse="!isOpen(op)" ng-click="$event.stopPropagation()" aria-expanded="false" aria-hidden="true">\n        <div ng-if="isOpen(op)">\n          <div class="legend form-block" translate="">Response</div>\n          <textarea class="form-control command-response" rows="{{getTextAreaRows(op.c8y_Command.result)}}" readonly="">{{op.c8y_Command.result}}</textarea>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>\n',e.put("devicemanagement_deviceShell/views/list.html",n),e.put("/apps/devicemanagement/deviceShell/views/list.html",n)}angular.module("c8y.deviceShell").run(["$templateCache",e])}();