/* core_tenantStatistics 8.7.2 2017-08-02T09:55:45+00:00 e22b35b1d531 (hotfix/8.7.2) tip */
!function(){"use strict";function t(t,e,n){t.addNavigation({parent:n("Tenants"),name:n("Usage statistics"),path:"tenantStatistics",icon:"c8y-usage-statistics",showIf:["c8yUserUtil",function(t){return t.showTenantManagement()}]}),e.when("/tenantStatistics",{templateUrl:"core_tenantStatistics/views/list.html",controller:"tenantStatisticsListCtrl"})}t.$inject=["c8yNavigatorProvider","c8yViewsProvider","gettext"],angular.module("c8y.tenantStatistics",["c8y.csvExporter"]).config(t)}(),function(){"use strict";function t(t,e,n,i,a,r,o,s,c,l,u,m,d,g,p){function f(){h(),v().then(x).then(z).then(D).then(B)}function h(){t.dateFrom=l.stringToDate(n.dateFrom)||N,t.dateTo=l.stringToDate(n.dateTo)}function v(){return o.list(y()).then(C)}function y(){return{dateFrom:l.dateToString(t.dateFrom),dateTo:l.dateToString(t.dateTo)}}function C(e){return t.formattedStatistics=b(e),t.statistics=S(e),w(e.length),e}function b(t){var e=_.cloneDeep(t);return e=a("orderBy")(e,"tenantId"),_.map(e,function(t){return t.storageSize=P(t),t.subscribedApplications=_.filter(t.subscribedApplications),t})}function P(e){var n;return n=t.storageLimitFeatureEnabled&&e.storageLimitPerDevice?[a("bytes")(e.storageSize),a("bytes")(M(e.storageLimitPerDevice,e.deviceWithChildrenCount))].join("/"):a("bytes")(e.storageSize)}function S(t){return _.forEach(t,function(t){t.storageSize=T(t.storageSize),t.storageLimitPerDevice&&(t.storageLimitPerDevice=T(t.storageLimitPerDevice))}),t}function T(t){return Number((t/Math.pow(2,20)).toFixed(2))}function x(){var e="c8ySchema!!customProperties";return U.list().then(function(t){return _.filter(t,{id:e})}).then(function(t){return U.getSchema(t)}).then(function(t){var e=_.get(t,"properties.customProperties.properties",{});return _.map(e,function(t,e){return{title:t.title,key:e,schema:t}})}).then(function(e){t.customProperties=_.sortBy(e,"title")})}function D(){t.columns=q(),t.columnsConfig={},t.csvHeaders=_.map(t.columns,function(t){return _.get(t,"header.csv")||_.get(t,"header.text")||_.get(t,"header")})}function B(e){t.columnsConfig=e,t.filteredSortedStatistics=d.filterSort(t.formattedStatistics,t.columns,t.columnsConfig)}function q(){var e=[m.getTenantIdColumn(),F(),m.getApiRequestsColumn(),m.getDeviceApiRequestsColumn(),t.storageLimitFeatureEnabled?m.getStorageQuotaEnabledColumn():null,m.getStorageSizeColumn(),m.getRootDevicesColumn(),m.getDevicesColumn(),m.getSubscribedApplicationsColumn(),m.getCreationTimeColumn(),t.isTopTenant?m.getParentTenantIdColumn():null];return _.filter(_.flattenDeep(e))}function F(){return _.map(t.customProperties,function(t){return m.getCustomPropertyColumn(t)})}function k(){var e=d.filterSort(t.statistics,t.columns,t.columnsConfig);return _.map(e,I)}function I(e){var n=[];return n.push(e.tenantId),_.forEach(t.customProperties,function(t){n.push($(e,t))}),n.push(e.requestCount),n.push(e.deviceRequestCount),t.storageLimitFeatureEnabled&&n.push(M(e.storageLimitPerDevice,e.deviceWithChildrenCount)||p.getString("Disabled")),n.push(e.storageSize),n.push(e.deviceCount),n.push(e.deviceWithChildrenCount),n.push((e.subscribedApplications||[]).join(" ")),n.push(e.creationTime&&moment(e.creationTime).format("L")),t.isTopTenant&&n.push(e.parentTenantId),n}function M(t,e){var n=t;return n&&(n*=e||1),n}function L(){_.isEqual(t.dateFrom,N)&&_.isUndefined(t.dateTo)||i.search(y())}function w(t){var e=p.getPlural(t,"1 tenant","{{$count}} tenants",{});c.changeTitle({title:g("Tenants usage statistics"),subtitle:_.isNumber(t)?e:""})}function E(){i.search({})}function A(t){i.path("/tenants/"+t.tenantId)}function R(){f()}function z(){return s.isCurrentUserTopTenant().then(function(e){return t.isTopTenant=e,e})}function $(t,e){var n=_.get(e,"schema.default");return _.get(t,["tenantCustomProperties",e.key],n)}function W(t){B(t)}var N=l.stringToDate(r.fromThisMonthStartFilter().dateFrom),U=u.another(u.paths.Tenants),j=g("No tenants to display.");t.statistics=[],t.filter=L,t.clearFilter=E,t.detail=A,t.refresh=R,t.csvData=k,t.storageLimitFeatureEnabled=r.appOption("storageLimitationFeatureEnabled"),t.getTenantCustomPropertyValue=$,t.onColumnsConfigChanged=W,t.noItemsMessage=j,f()}t.$inject=["$scope","$q","$routeParams","$location","$filter","c8yBase","c8yStatistics","c8yTenant","c8yTitle","c8yUtil","c8yPropertiesLibrary","c8yTenantStatisticsColumns","c8yFilteringSortingCollections","gettext","gettextCatalog"],angular.module("c8y.tenantStatistics").controller("tenantStatisticsListCtrl",t)}(),function(){"use strict";function t(t,e,n){function i(){return t.getColumn({name:"tenantId",header:n("Id"),cell:{template:"{{item.tenantId}}"},filteringByPattern:{itemProperty:"tenantId"},sortingByPath:{itemProperty:"tenantId"}})}function a(e){var n=e.key,i=["tenantCustomProperties",n],a={name:n,header:{text:e.title,csv:"externalReference"===n?e.title:n},cell:{template:"<div ng-bind-html=\"getValue(item, '"+n+"') | formatBySchema:getSchema(tenantCustomProperties, '"+n+"')\"></div>",scopeExtensions:{getValue:function(t,e){return _.get(t,["tenantCustomProperties",e])},getSchema:function(t,e){return _.get(t,[e,"schema"])}}}};return _.merge(a,r(e)),_.set(a.cell.scopeExtensions,i,e),t.getColumn(a)}function r(t){var n=e.getType(t),i=n.filteringKey,a="sortingByPath",r=["tenantCustomProperties",t.key],o={itemProperty:r},s={};return _.set(s,i,o),_.set(s,a,o),s}function o(){return t.getColumn({name:"requestCount",header:n("API requests"),cell:{template:"{{item.requestCount}}"},filteringByMinMax:{itemProperty:"requestCount"},sortingByPath:{itemProperty:"requestCount"}})}function s(){return t.getColumn({name:"deviceRequestCount",header:n("Device API requests"),cell:{template:"{{item.deviceRequestCount}}"},filteringByMinMax:{itemProperty:"deviceRequestCount"},sortingByPath:{itemProperty:"deviceRequestCount"}})}function c(){return t.getColumn({name:"storageLimitPerDevice",header:{text:n("Storage quota"),csv:n("Storage quota (MB)")},cell:{template:'<input type="checkbox" disabled="true" ng-checked="!!item.storageLimitPerDevice">'},filteringByBoolean:{itemProperty:"storageLimitPerDevice"},sortingByPath:{itemProperty:"storageLimitPerDevice"}})}function l(){return t.getColumn({name:"storageSize",header:{text:n("Storage"),tooltip:{icon:"question-circle-o",text:n("When a storage quota is set, total used storage over storage quota is displayed")},csv:n("Storage (MB)")},cell:{template:"{{item.storageSize}}"},filteringByMinMax:{itemProperty:"storageSize"}})}function u(){return t.getColumn({name:"deviceCount",header:{text:n("Root devices"),tooltip:{icon:"question-circle-o",text:n("Number of root devices, excluding child devices")}},cell:{template:"{{item.deviceCount}}"},filteringByMinMax:{itemProperty:"deviceCount"},sortingByPath:{itemProperty:"deviceCount"}})}function m(){return t.getColumn({name:"deviceWithChildrenCount",header:{text:n("Devices"),tooltip:{icon:"question-circle-o",text:n("Number of devices, including child devices")}},cell:{template:"{{item.deviceWithChildrenCount}}"},filteringByMinMax:{itemProperty:"deviceWithChildrenCount"},sortingByPath:{itemProperty:"deviceWithChildrenCount"}})}function d(){return t.getColumn({name:"subscribedApplications",header:n("Subscribed applications"),cell:{template:"{{(item.subscribedApplications || []).length}}"},filteringByMinMax:{itemProperty:"subscribedApplications.length"},sortingByPath:{itemProperty:"subscribedApplications.length"}})}function g(){return t.getColumn({name:"creationTime",header:n("Creation time"),cell:{template:"{{item.creationTime | absoluteDate}}"},filteringByMinMaxDate:{itemProperty:"creationTime"},sortingByPath:{itemProperty:"creationTime"}})}function p(){return t.getColumn({name:"parentTenantId",header:n("Parent tenant"),cell:{template:"{{item.parentTenantId}}"},filteringByPattern:{itemProperty:"parentTenantId"},sortingByPath:{itemProperty:"parentTenantId"}})}return{getTenantIdColumn:i,getCustomPropertyColumn:a,getApiRequestsColumn:o,getDeviceApiRequestsColumn:s,getStorageQuotaEnabledColumn:c,getStorageSizeColumn:l,getRootDevicesColumn:u,getDevicesColumn:m,getSubscribedApplicationsColumn:d,getCreationTimeColumn:g,getParentTenantIdColumn:p}}t.$inject=["c8yFilteringSortingCollections","SchemaPropertiesSvc","gettext"],angular.module("c8y.tenantStatistics").factory("c8yTenantStatisticsColumns",t)}(),function(){"use strict";function t(t){var e;e='\n\n<div class="c8y-toolbar-spacer page-toolbar">\n  <div class="c8y-toolbar navbar navbar-default">\n    <div class="navbar-header">\n      <button type="button" class="navbar-toggle collapsed" ng-click="isPageToolbarExpanded = !isPageToolbarExpanded" aria-expanded="false">\n        <span class="sr-only">Toggle Toolbar</span>\n        <span class="icon-bar"></span>\n        <span class="icon-bar"></span>\n        <span class="icon-bar"></span>\n      </button>\n    </div>\n\n    <div id="page-toolbar" class="navbar-collapse collapse" uib-collapse="!isPageToolbarExpanded" aria-expanded="false" aria-hidden="true" style="height: 0px">\n\n      <ul class="nav navbar-nav navbar-left">\n        <li class="navbar-form">\n          <form class="form-inline">\n            <div class="form-group datepicker">\n              <input class="form-control" placeholder="{{\'From`date`\' | translate}}" ng-model="dateFrom" uib-datepicker-popup show-button-bar="false" show-weeks="false" max-date="dateTo" is-open="openFrom" ng-click="openFrom=true" style="width: 120px; text-align: center">\n            </div>\n            <div class="form-group datepicker">\n              <input class="form-control" placeholder="{{\'To`date`\' | translate}}" ng-model="dateTo" uib-datepicker-popup show-button-bar="false" show-weeks="false" min-date="dateFrom" is-open="openTo" ng-click="openTo=true" style="width: 120px; text-align: center">\n            </div>\n            <button type="button" class="btn btn-link" ng-click="filter()" title="{{\'Filter\' | translate}}"><i c8y-icon="filter"></i> <span translate>Filter</span></button>\n            <button type="button" class="btn btn-link" ng-click="clearFilter()" ng-show="dateFrom || dateTo" title="{{\'Clear\' | translate}}"><i c8y-icon="times"></i> <span translate>Clear</span></button>\n          </form>\n        </li>\n      </ul>\n      <ul class="nav navbar-nav navbar-right">\n        <li>\n          <a c8y-csv-exporter c8y-data="csvData()" c8y-headers="csvHeaders" href="" class="btn btn-link">\n            <i c8y-icon="table"></i> {{\'Export CSV\' | translate}}\n          </a>\n        </li>\n        <li>\n          <button type="button" class="btn btn-link" data-ng-click="refresh()">\n              <i c8y-icon="refresh" data-ng-class="{\'fa-spin\': refreshLoading}"></i> {{\'Reload\' | translate}}\n          </button>\n        </li>\n      </ul>\n    </div>\n  </div>\n</div>\n\n\n\n<div>\n  <div>\n\n\n\n  </div>\n\n  <c8y-filtered-sorted-list columns="columns" columns-config="columnsConfig" on-columns-config-changed="onColumnsConfigChanged(columnsConfig)" items="filteredSortedStatistics" no-items-message="noItemsMessage" on-item-click="detail(item)">\n  </c8y-filtered-sorted-list>\n</div>\n',t.put("core_tenantStatistics/views/list.html",e),t.put("/apps/core/tenantStatistics/views/list.html",e)}angular.module("c8y.tenantStatistics").run(["$templateCache",t])}();