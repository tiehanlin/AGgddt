/* core_htmlWidget 8.7.2 2017-08-02T09:54:30+00:00 e22b35b1d531 (hotfix/8.7.2) tip */
!function(){"use strict";function e(e,n){e.add({name:"Html widget",nameDisplay:n("HTML"),description:n("Display custom HTML code"),templateUrl:"core_htmlWidget/views/htmlWidget.html",configTemplateUrl:"core_htmlWidget/views/config.html",options:{groupsSelectable:!0}})}angular.module("c8y.parts.htmlwidget",[]).config(["c8yComponentsProvider","gettext",e])}(),function(){"use strict";function e(e,n){function t(){e.htmlCodeTooltipVisible=!e.htmlCodeTooltipVisible}e.htmlCodeTooltipVisible=!1,e.toggleHtmlCodeTooltip=t}angular.module("c8y.parts.htmlwidget").controller("htmlWidgetConfigCtrl",["$scope","gettext",e])}(),function(){"use strict";function e(e,n,t,i,l,c,o,s,a,r){function u(){return r.getSummary().then(function(n){e.devicesCount=n.data.deviceWithChildrenCount,e.variables.push(e.devicesCount)})}function d(){return c.mustHaveAnyRole(["ROLE_USER_MANAGEMENT_READ"]).then(n.list).then(function(n){e.usersCount=n.length,e.variables.push(e.usersCount)})}function v(){return t.list({pageSize:1e3}).then(function(n){e.onlineCount=_.filter(n,function(e){return i.isDeviceAvailable(e)}).length})}function h(){return l.list({fragmentType:"c8y_ActiveAlarmsStatus"}).then(function(n){e.criticalDevicesCount=_.filter(n,function(e){return e.c8y_ActiveAlarmsStatus&&e.c8y_ActiveAlarmsStatus.critical}).length,e.variables.push(e.criticalDevicesCount)})}function g(){return l.getCount({fragmentType:"c8y_IsDeviceGroup"}).then(function(n){e.deviceGroupsCount=n,e.variables.push(e.deviceGroupsCount)})}function f(e,n){return o.all({device:l.detail(e).then(s.getResData),children:n?t.listChildren(e):[]}).then(m)}function m(n){e.device=n.device,e.devices={},e.variables=[],e.devices[n.device.id]=n.device,_.forEach(n.children,function(n){e.devices[n.id]=n}),e.variables.push(e.device),e.variables.push(e.devices)}function p(){e.reloading=!0;var n=S.isCustomVariableUsed("devices"),t=S.isCustomVariableUsed("device")||n;return t?f(e.child.config.device.id,n).then(function(){e.reloading=!1}):(e.reloading=!1,o.when())}function b(n,t){!e.reloading&&e.device&&(w(t)?C(t):y(t))}function C(n){_.isEqual(n.childDevices,e.device.childDevices)&&_.isEqual(n.childAssets,e.device.childAssets)?(e.device=n,e.devices[n.id]=n):p()}function y(n){e.devices[n.id]=n}function w(n){return e.device.id===n.id}function T(){return"/managedobjects/*"}function A(){a.addListener(e.$id,T(),a.realtimeActions().UPDATE,b),a.start(e.$id,T())}function $(){a.stop(e.$id,T())}function D(){e.devices&&$(),e.device=null,e.devices=null}function W(e){return e.replace(new RegExp("\\s+","g"),"")}function x(n){return W(e.child.config.html).indexOf("{{"+n+"}}")>-1}function E(){H(),D(),p().then(function(){A()})}function H(){var n=[];e.countersLoaded=!1,x("devicesCount")&&n.push(u()),x("deviceGroupsCount")&&n.push(g()),x("usersCount")&&n.push(d()),x("criticalDevicesCount")&&n.push(h()),x("onlineCount")&&n.push(v()),o.all(n).then(function(){e.countersLoaded=!0})}var S=this;this.isCustomVariableUsed=function(n){n=n.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1");var t=new RegExp("\\s*"+n+"\\s*(\\.|(\\[.*\\]))\\s*.*");return t.test(W(e.child.config.html))},e.$watch("child.config.device",function(e,n){e&&!_.isEqual(e,n)&&E()},!0),e.$watch("child.config.html",function(e,n){void 0===e||_.isEqual(e,n)||E()}),e.$on("$destroy",D),e.variables=[],E()}angular.module("c8y.parts.htmlwidget").controller("HtmlWidgetCtrl",["$scope","c8yUser","c8yDevices","c8yDeviceStatus","c8yInventory","c8yPermissions","$q","c8yBase","c8yRealtime","c8yStatistics",e])}(),angular.module("c8y.parts.htmlwidget").directive("c8yHtmlWidget",["$compile","$sanitize",function(e,n){"use strict";function t(t,i){function l(l,c){l&&l!==c&&(t.child.config.unsafe?i.html(t.child.config.html):i.html(n(t.child.config.html)),e(i.contents())(t))}t.$watch("child.config.html",l),t.$watch("child.config.unsafe",function(){l(t.child.config.html)}),l()}return{restrict:"A",link:t}}]),function(){"use strict";function e(e){var n;n='<div ng-controller="htmlWidgetConfigCtrl" class="html-widget-config">\n  <div class="form-group">\n    <label translate>HTML code</label>\n    <button class="btn btn-link" ng-click="toggleHtmlCodeTooltip()" uib-tooltip="{{\'Toggle help text\' | translate}}">\n      <i c8y-icon="question-circle-o" ng-class="{\'text-primary\': !htmlCodeTooltipVisible, \'text-muted\': htmlCodeTooltipVisible}"></i>\n    </button>\n    <div class="alert alert-info text-left" ng-show="htmlCodeTooltipVisible">\n      <p translate>You can use the following variables in your HTML code:</p>\n      <ul>\n        <li>\n          <var ng-non-bindable>{{device}}</var> &ndash;\n          <translate>current device or group, you can access its properties e.g.</translate> <var ng-non-bindable>{{device.name}}</var>,\n        </li>\n        <li>\n          <var ng-non-bindable>{{devices}}</var> &ndash;\n          <translate>children of current device or group, you can access their properties e.g.</translate> <var ng-non-bindable>{{devices[14200].name}}</var>,\n        </li>\n        <li>\n          <var ng-non-bindable>{{devicesCount}}</var> &ndash;\n          <translate>number of devices</translate>,\n        </li>\n        <li>\n          <var ng-non-bindable>{{deviceGroupsCount}}</var> &ndash;\n          <translate>number of device groups</translate>,\n        </li>\n        <li>\n          <var ng-non-bindable>{{usersCount}}</var> &ndash;\n          <translate>number of users</translate>,\n        </li>\n        <li>\n          <var ng-non-bindable>{{criticalDevicesCount}}</var> &ndash;\n          <translate>number of devices with critical alarm status</translate>,\n        </li>\n        <li>\n          <var ng-non-bindable>{{onlineCount}}</var> &ndash;\n          <translate>number of online devices</translate>.\n        </li>\n      </ul>\n    </div>\n    <div class="checkbox">\n      <label>\n        <input type="checkbox" ng-model="config.unsafe"> {{\'Allow insecure use of elements and attributes\' | translate}}\n      </label>\n    </div>\n    <textarea class="form-control" ng-model="config.html" rows="10" required></textarea>\n  </div>\n</div>\n',e.put("core_htmlWidget/views/config.html",n),e.put("/apps/core/htmlWidget/views/config.html",n),n='<div ng-controller="HtmlWidgetCtrl" c8y-html-widget>\n</div>\n',e.put("core_htmlWidget/views/htmlWidget.html",n),e.put("/apps/core/htmlWidget/views/htmlWidget.html",n)}angular.module("c8y.parts.htmlwidget").run(["$templateCache",e])}();