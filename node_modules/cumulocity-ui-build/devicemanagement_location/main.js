/* devicemanagement_location 8.7.2 2017-08-02T09:53:40+00:00 2e289fd803cb (hotfix/8.7.2) tip */
angular.module("c8y.parts.location", ["leaflet-directive"]).config(["c8yViewsProvider", "c8yComponentsProvider", "gettext", function(n, e, a) {
		function t(n, e, t, o) {
			//n是$routeParams t是c8yDevices o是c8yActions
			var i = n.deviceId,
				s = "/device/" + i + "/location",
				c = t.detailCached(i).then(function(n) {
					var e = n.data,
						a = "c8y_Position",
						t = "com_nsn_startups_vendme_fragments_GPSCoordinates",
						l = e[a] || e[t];
					return l
				});
			return c.then(function(n) {
				n || o.addAction({
					text: a("Add location"),
					priority: 1e3,
					showIfPermissions: {
						adminMOs: [i]
					},
					action: function() {
						t.save({
							id: i,
							c8y_Position: _.cloneDeep(l)
						}).then(function() {
							e.path(s)
						})
					}
				})
			}), c
		}
		var l = {
			lat: 51.2433101,
			lng: 6.7303924
		};
		n.when("/device/:deviceId", {
			name: a("Location"),
			templateUrl: "devicemanagement_location/views/index.html",
			icon: "location-arrow",
			showIf: ["$routeParams", "$location", "c8yDevices", "c8yActions", t]
		}), e.add({
			name: a("Location"),
			description: a("Displays a map with device position marker"),
			templateUrl: "devicemanagement_location/views/component.html",
			options: {
				noNewWidgets: !0
			}
		})
	}]), angular.module("c8y.parts.location").controller("locationCtrl", ["$scope", "$routeParams", "c8yBase", "c8yGeo", "c8yDevices", "c8yRealtime", "c8yAlert", "gettext", function(n, e, a, t, l, o, i, s) {
		"use strict";

		function c(e) {
			D = e;
			var a = n.location = h(e) || {};
			v(a) && p(a)
		}

		function r(n, e) {
			b(e.model)
		}

		function d(n) {
			if(n) {
				var e = {
					lat: Number(n.lat),
					lng: Number(n.lon),
					zoom: 17
				};
				p(e), b(e), y(e)
			}
		}

		function v(n) {
			return !(!n.lat || !n.lng)
		}

		function u() {
			return n.child && n.child.config && n.child.config.device && (T.draggable = !1), n.child && n.child.config && n.child.config.device && n.child.config.device.id || e.deviceId
		}

		function m() {
			l.detailCached(u()).then(function(n) {
				return _.cloneDeep(n.data)
			}).then(c)
		}

		function p(n) {
			_.assign(T, {
				lat: parseFloat(n.lat),
				lng: parseFloat(n.lng)
			}), M.main = T, y(T)
		}

		function g(n) {
			return n %= 360, n < -180 ? n + 360 : n > 180 ? n - 360 : n
		}

		function b(e) {
			_.assign(n.location, {
				lat: parseFloat(e.lat),
				lng: g(parseFloat(e.lng))
			})
		}

		function f(n) {
			return l.isVendme(n) ? P : F
		}

		function h(n) {
			return n[f(n)]
		}

		function y(e) {
			var a = e || T;
			n.center = n.center, _.assign(n.center, a)
		}

		function w(n) {
			t.geoCode(n).then(function(n) {
				return 0 === n.data.length && i.warning(s("Address could not be found!")), n.data[0] || null
			}).then(d)
		}

		function C() {
			var n = {
					id: D.id
				},
				e = _.clone(h(D));
			delete e.address, n[f(D)] = e, l.save(n).then(_.partial(i.success, s("Location successfully saved!"))).then(m)
		}

		function k(n, e) {
			c(e)
		}

		function x(n, e) {
			c(e)
		}

		function $() {
			m()
		}

		function A() {
			I ? n.switchRealtime() : m()
		}
		var D, F = "c8y_Position",
			P = "com_nsn_startups_vendme_fragments_GPSCoordinates",
			L = {
				latitude: /^[-+]?([1-8]?\d(\.\d+)?|90(\.0+)?)$/,
				longitude: /^[-+]?(180(\.0+)?|((1[0-7]\d)|([1-9]?\d))(\.\d+)?)$/,
				altitude: /^[-+]?(0|([1-9]\d*))(\.\d+)?$/
			},
			I = !1,
			z = 11,
			E = {},
			M = {},
			T = {
				focus: !0,
				draggable: !0
			},
			G = {
				scrollWheelZoom: !1
			},
			N = {
				lat: 0,
				lng: 0,
				zoom: z
			},
			R = {
				markers: ["dragend"]
			};
		n.settings = E, n.markers = M, n.mapDefaults = G, n.centerMap = y, n.center = N, n.pattern = L, n.$on("leafletDirectiveMarker.dragend", r), n.events = R, n.gotoAddress = w, n.save = C, n.realtimeChannel = "/managedobjects/" + (void 0 !== e.deviceId ? e.deviceId : "*"), n.invalid = angular.bind(a, a.invalid, n), n.$watch("child.config.device", m), o.addListener(n.$id, n.realtimeChannel, n.$id + "-subscribed", $), o.addListener(n.$id, n.realtimeChannel, "CREATE", k), o.addListener(n.$id, n.realtimeChannel, "UPDATE", x), A()
	}]),
	function() {
		"use strict";

		function n(n) {
			var e;
			e = '<div data-ng-controller="locationCtrl">\n<leaflet width="100%" height="250px" markers="markers" center="center" defaults="mapDefaults" event-broadcast="events"></leaflet>\n</div>', n.put("devicemanagement_location/views/component.html", e), n.put("/apps/devicemanagement/location/views/component.html", e), e = '<div data-ng-controller="locationCtrl">\n\n  <div class="c8y-toolbar-spacer">\n    <div class="c8y-toolbar navbar navbar-default">\n\n      <div class="navbar-header">\n        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#page-toolbar" aria-expanded="false">\n          <span class="sr-only">Toggle Toolbar</span>\n          <span class="icon-bar"></span>\n          <span class="icon-bar"></span>\n          <span class="icon-bar"></span>\n        </button>\n      </div>\n\n      <div id="page-toolbar" class="collapse navbar-collapse">\n\n\n        <ul class="nav navbar-nav navbar-right">\n          <li>\n            <c8y-realtime-btn class="btn btn-link" style="margin-left: -12px"></c8y-realtime-btn>\n          </li>\n\n          <li>\n            <button class="btn btn-link" title="Center map" ng-click="centerMap()"><i c8y-icon="dot-circle-o"></i> Center map</button>\n          </li>\n\n\n        </ul>\n      </div>\n    </div>\n  </div>\n\n\n  <div class="row">\n    <div class="col-md-8">\n      <leaflet width="100%" height="600px" style="margin-bottom:15px" markers="markers" center="center" defaults="mapDefaults" event-broadcast="events"></leaflet>\n    </div>\n\n    <div class="col-md-4">\n      <div class="card">\n        <div class="card-header">\n          <span class="h4 card-title" translate>Current device location</span>\n\n        </div>\n        <hr>\n        <div class="card-block" ng-class="{\'form-read-only\': !noeditable}">\n\n\n          <form name="locationForm" novalidate class="form-horizontal">\n            <div class="form-group" ng-class="{\'has-error\': invalid(\'locationForm\', \'latitude\')}">\n              <label translate class="col-sm-3 control-label">Latitude</label>\n              <div class="col-sm-9">\n                <input name="latitude" class="form-control" ng-model="location.lat" ng-pattern="pattern.latitude">\n              </div>\n            </div>\n\n            <div class="form-group" ng-class="{\'has-error\': invalid(\'locationForm\', \'longitude\')}">\n              <label translate class="col-sm-3 control-label">Longitude</label>\n              <div class="col-sm-9">\n                <input name="longitude" class="form-control" ng-model="location.lng" ng-pattern="pattern.longitude">\n              </div>\n            </div>\n\n            <div class="form-group" ng-class="{\'has-error\': invalid(\'locationForm\', \'altitude\')}">\n              <label translate class="col-sm-3 control-label">Altitude</label>\n              <div class="col-sm-9">\n                <input type="number" name="altitude" class="form-control">\n              </div>\n            </div>\n          </form>\n        </div>\n        <hr ng-show="noeditable" style="margin-bottom: 20px">\n        <div class="form-horizontal" style="padding: 0 20px">\n          <div class="form-group">\n            <form name="addressForm" ng-show="noeditable" novalidate ng-submit="gotoAddress(location.address)">\n              <label class="control-label col-sm-3" translate>Address</label>\n              <div class="col-sm-9">\n                <div class="input-group input-group-search">\n                  <input type="text" ng-model="location.address" placeholder="{{\'Find lat/long by address\' | translate}}" class="form-control">\n                  <span class="input-group-btn">\n                    <button class="btn btn-link" type="submit">\n                      <i c8y-icon="search"></i>\n                    </button>\n                  </span>\n                </div>\n              </div>\n            </form>\n          </div>\n        </div>\n\n        <hr>\n        <div class="card-footer">\n          <button class="btn btn-default" ng-show="noeditable" ng-click="noeditable = !noeditable">Cancel</button>\n          <a href="" class="btn btn-primary" ng-show="noeditable" ng-disabled="locationForm.$invalid" ng-click="save()" translate>Save</a>\n\n          <div ng-show="!noeditable">\n            <button class="btn btn-default" ng-click="noeditable = !noeditable"><i c8y-icon="pencil"></i> Edit location</button>\n            <span class="">\n              <a tabindex="0" uib-popover-html="\'Device location may be set by the device itself, or manually in the platform\' | translate" popover-append-to-body="true" popover-placement="left" popover-trigger="\'focus\'" style="display:inline-block">\n                <i class="fa fa-question-circle"></i>\n              </a>\n            </span>\n          </div>\n        </div>\n      </div>\n\n    </div>\n  </div>\n\n</div>\n', n.put("devicemanagement_location/views/index.html", e), n.put("/apps/devicemanagement/location/views/index.html", e)
		}
		angular.module("c8y.parts.location").run(["$templateCache", n])
	}();