/* core_userRoles 8.7.2 2017-08-02T09:55:58+00:00 e22b35b1d531 (hotfix/8.7.2) tip */
!function(){"use strict";function e(e){e.initUi()}e.$inject=["c8yUserRolesUiProvider"],angular.module("c8y.userRoles",[]).config(e)}(),function(){"use strict";function e(e,n,t){function s(){return o().then(r)}function o(){var e={fragmentType:"c8y_IsDeviceGroup",pageSize:1e4};return t.list(e)}function r(e){var n=_(e).filter({type:"c8y_DeviceGroup"}).sortBy("name").map(_.partial(l,e)).value();return i(e),n}function l(e,n){var t=_(n.childAssets.references).map("managedObject").map("id").value();if(!n._subGroups){var s=_.reduce(t,function(n,t){var s=_.find(e,{id:t});return s&&n.push(l(e,s)),n},[]);n._subGroups=_.sortBy(s,"name")}return n}function i(e){_.forEach(e,function(n){n._parentGroups=_.uniq(a(e,n))})}function a(e,n){if("c8y_DeviceGroup"===n.type)return[];var t=_.filter(e,function(e){var t=e._subGroups;return t&&t.indexOf(n)>-1});return _(t).map(function(n){return a(e,n)}).flatten().union(t).value()}function c(e,n,t){var s=n||0,o=t||[];if(s>15)throw new Error("Exceeded maximum level of nesting");return _.reduce(e,function(e,n){var t=_.clone(n);return t._depth=s,e.push(t),c(n._subGroups,s+1,e)},o)}function u(t,s,o,r){var l,i=e.when();return r?(i=e.all(_.map(s,function(e){return n.removeInventoryRoles(o,e.id)})),l=function(){return e.all(_.map(t,function(e){var t=_.map(e.roles,function(e){return{id:e.id}});return n.assignInventoryRoles(o,e.managedObject,t)}))}):l=function(){return e.all(_.map(t,function(e){var t,r=e.managedObject,l=_.find(s,{managedObject:r}),i=_.get(l,"roles"),a=_.get(l,"id"),c=_(_.union(e.roles,i)).uniqBy("id").map(function(e){return{id:e.id}}).value();return t=a?n.updateInventoryRoles(o,a,c):n.assignInventoryRoles(o,r,c)}))},i.then(l)}return{getAssetTree:s,flatTree:c,copyUserRoles:u}}e.$inject=["$q","c8yUser","c8yInventory"],angular.module("c8y.userRoles").factory("c8yUserInventoryRoles",e)}(),function(){"use strict";function e(e,n){function t(e){return e.userId&&"new"!==e.userId}function s(e){this.userId=e.userId}function o(){r()}function r(){n.when(i,c)}function l(n,t,s){function o(e){var n={component:"c8yCopyRolesModal",resolve:{userTo:_.constant(e)}};return s.open(n).result}function r(){var n=e("User roles copied successfully");return t.success(n)}function l(){try{return n.get("c8yRolesUiStrings")}catch(e){return{}}}return{STRINGS:l(),copyFromUserDialog:o,successUserRolesCopy:r}}t.$inject=["$routeParams"],s.$inject=["$routeParams"],l.$inject=["$injector","c8yAlert","$uibModal"];var i="/users/:userId",a="th-list",c={template:'<c8y-user-inventory-roles-tab user="vm.userId"></c8y-user-inventory-roles-tab>',name:e("Inventory roles"),icon:a,controllerAs:"vm",controller:s,showIf:t};return{$get:l,initUi:o}}e.$inject=["gettext","c8yViewsProvider"],angular.module("c8y.userRoles").provider("c8yUserRolesUi",e)}(),function(){"use strict";function e(e,n,t,s,o,r){function l(){n.listInventoryRoles(d.user).then(t.getResData).then(function(e){d.assignedRoles=_.keyBy(e.inventoryAssignments,"managedObject")}),n.detail(d.user).then(t.getResData).then(function(e){e.owner&&n.listInventoryRoles(e.owner).then(t.getResData).then(function(e){d.ownerAssignedRoles=_.keyBy(e.inventoryAssignments,"managedObject")})})}function i(e){e.user&&l()}function a(t,s){var o,r=d.user,i=d.assignedRoles||{},a=(i[s]||{}).id;return a?o=t.length?n.updateInventoryRoles(r,a,t):n.removeInventoryRoles(r,a):t.length&&(o=n.assignInventoryRoles(r,s,t)),o?o.then(l):e.when()}function c(){o.copyFromUserDialog(d.user).then(u)}function u(e){var n="replace"===e.process,t=e.roles,r=_.map(d.assignedRoles);return s.copyUserRoles(t,r,d.user,n).then(l).then(o.successUserRolesCopy)}var d=this;_.assign(d,{$onChange:i,onChangeRoles:a,copyRoles:c,helpLink:r.docsPath(_.get(o.STRINGS,"LINKS.ROLES_INVENTORY"))}),l()}e.$inject=["$q","c8yUser","c8yBase","c8yUserInventoryRoles","c8yUserRolesUi","c8yUiUtil"],angular.module("c8y.userRoles").component("c8yUserInventoryRolesTab",{templateUrl:"core_userRoles/inventoryRolesTab/inventoryRolesTab.html",controllerAs:"vm",controller:e,bindings:{user:"<"}})}(),function(){"use strict";function e(e,n){function t(){return e.getAssetTree().then(function(n){c.flatAssetTree=e.flatTree(n)})}function s(){n.list().then(function(e){c.inventoryRoles=e})}function o(e){(e.assignedRoles||e.ownerAssignedRoles)&&u.then(r)}function r(){if(c.assignedRoles&&(c.inheritedRoles=l(c.flatAssetTree,c.assignedRoles)),c.ownerAssignedRoles){var e=l(c.flatAssetTree,c.ownerAssignedRoles);c.ownerAllAssignedRoles=_.mergeWith(e,c.ownerAssignedRoles,function(e,n){return n?e?_.uniqBy(e.concat(n.roles),"id"):n.roles:e})}}function l(e,n){return _.reduce(e,function(e,t){return e[t.id]=_(t._parentGroups).map(function(e){return _.get(n,e.id)}).filter(_.identity).map(_.property("roles")).flatten().uniqBy("id").value(),e},{})}function i(e,n){return c.onChangeRoles({managedObjectId:n,roles:e})}function a(e){return!c.ownerAllAssignedRoles||_.get(c.ownerAllAssignedRoles,[e.id,"length"])}var c=this;_.assign(c,{filterAsset:a,onApply:i,$onChanges:o});var u=t();s()}e.$inject=["c8yUserInventoryRoles","c8yRoles"],angular.module("c8y.userRoles").component("c8yRolesAssetTree",{templateUrl:"core_userRoles/rolesAssetTree/rolesAssetTree.html",controllerAs:"vm",controller:e,bindings:{searchFilter:"<",assignedRoles:"<",ownerAssignedRoles:"<",onChangeRoles:"&"}})}(),function(){"use strict";function e(e,n,t){function s(e){e.assignedRoles&&o(),e.inheritedRoles&&r()}function o(){A=_.clone((b.assignedRoles||{}).roles)||[]}function r(){w=b.inheritedRoles}function l(){return a((b.assignedRoles||{}).roles)}function i(){return a(w)}function a(e){return _(e).sortBy(R).map(R).value().join(", ")}function c(e){return _.some(A,{id:e.id})||u(e)}function u(e){return _.some(w,{id:e.id})}function d(){v()?A.length=0:A=_.reject(p(),u)}function p(){return e("filter")(b.inventoryRoles,b.roleTextFilter)}function v(){return _.every(p(),c)}function g(e){c(e)?_.remove(A,{id:e.id}):(A.push(e),A=_.uniqBy(A,"id"))}function m(){var e=b.onApply({roles:A});e&&_.isFunction(e.then)&&_.isFunction(e.finally)?(b.saving=!0,e.finally(function(){b.saving=!1,b.isDropDownOpen=!1})):b.isDropDownOpen=!1}function y(e){e||o()}function f(e){return!b.ownerAllowedRoles||_.some(b.ownerAllowedRoles,{id:e.id})}function h(e){return n.trustAsHtml(['<div style="word-break: break-word; max-height: 300px; overflow-y: hidden;">',e,"</div>"].join(""))}function R(e){return t.getString(e.name)}var b=this,A=[],w=[];_.assign(b,{displayTextAssigned:l,displayTextInherited:i,$onChanges:s,toggle:g,toggleSelectAll:d,allSelected:v,isSelected:c,isInherited:u,apply:m,onToggleDropdown:y,isAllowedByOwner:f,getFormattedInventoryRoleDescription:_.memoize(h),translateName:R})}e.$inject=["$filter","$sce","gettextCatalog"],angular.module("c8y.userRoles").component("c8yInventoryRoleSelector",{templateUrl:"core_userRoles/inventoryRoleSelector/inventoryRoleSelector.html",bindings:{assignedRoles:"<",inheritedRoles:"<",inventoryRoles:"<",ownerAllowedRoles:"<",onApply:"&"},controllerAs:"vm",controller:e})}(),function(){"use strict";function e(e){function n(e){o.selecting||(o.selectedUser=e)}function t(e){return{roles:e.data.inventoryAssignments,process:o.process}}function s(){return o.copying=!0,e.listInventoryRoles(o.selectedUser).then(t).then(function(e){o.copying=!1,o.modalInstance.close(e)})}var o=this;_.assign(o,{selectUser:n,process:"merge",copy:s})}e.$inject=["c8yUser"],angular.module("c8y.userRoles").component("c8yCopyRolesModal",{templateUrl:"core_userRoles/copyRolesModal/copyRolesModal.html",bindings:{modal:"<",userTo:"<",modalInstance:"<",resolve:"<"},controller:e,controllerAs:"vm"})}(),function(){"use strict";function e(e){var n;n='<div class="modal-header text-center">\n  <h3>\n    <i c8y-icon="clipboard"></i>\n    <span translate>Copy roles from...</span>\n  </h3>\n</div>\n<div class="modal-body text-center">\n  <label style="margin-bottom: 0" translate>Current roles </label>&nbsp;\n  <label class="c8y-radio radio-inline">\n    <input type="radio" ng-model="vm.process" ng-value="\'merge\'"><span></span> {{\'Merge\' | translate}}\n  </label>\n  <label class="radio-inline c8y-radio">\n    <input type="radio" ng-model="vm.process" ng-value="\'replace\'"><span></span> {{\'Replace\' | translate}}\n  </label>\n</div>\n\n\n<c8y-ui-user-picker model-type="object" hidden-users="vm.resolve.userTo" ng-model="vm.selectedUser">\n</c8y-ui-user-picker>\n\n<div class="modal-footer">\n\n  <button class="btn btn-default" ng-click="vm.modalInstance.dismiss()" translate>Cancel</button>\n  \n  <button class="btn btn-primary" ng-disabled="!vm.selectedUser || vm.copying" ng-click="vm.copy()" translate>Copy</button>\n\n</div>\n',e.put("core_userRoles/copyRolesModal/copyRolesModal.html",n),e.put("/apps/core/userRoles/copyRolesModal/copyRolesModal.html",n),n='<div class="c8y-child-assets-selector" is-open="vm.isDropDownOpen" on-toggle="vm.onToggleDropdown(open)" uib-dropdown>\n\n  <button type="button" class="btn dropdown-toggle" title="{{vm.displayTextInherited()}} {{vm.displayTextAssigned()}}" uib-dropdown-toggle>\n    <span class="text-truncate">\n      <span class="text-muted" style="opacity:0.6">{{vm.displayTextInherited()}}</span>\n      <span ng-show="vm.displayTextInherited() && vm.displayTextAssigned()">/</span>\n      <span>{{vm.displayTextAssigned()}}</span>\n      <span class="text-muted" style="opacity:0.6" ng-hide="vm.displayTextInherited() || vm.displayTextAssigned()" translate>Select inventory roles...</span>\n    </span>\n  </button>\n\n  <ul class="dropdown-menu multiselect-container" ng-click="$event.stopPropagation();" uib-dropdown-menu style="margin-top:-32px">\n\n    <li class="multiselect-item">\n      <div class="input-group input-group-search">\n        <input class="form-control" type="text" placeholder="{{\'Type to filter\' | translate}}&hellip;" ng-model="vm.roleTextFilter">\n        <span class="input-group-addon">\n            <i c8y-icon="search" ng-class="{\'fa-spin\': loading}" class="fa fw fa-search"></i>\n        </span>\n      </div>\n\n    </li>\n\n    <li class="multiselect-item" ng-if="vm.isDropDownOpen">\n\n      <label class="c8y-checkbox input-sm" ng-click="vm.toggleSelectAll(); $event.preventDefault()">\n        <input type="checkbox" ng-checked="vm.allSelected()" ng-click="::vm.toggleSelectAll(); $event.stopPropagation()">\n        <span></span>\n        <span translate>All</span>\n      </label>\n\n    </li>\n\n    <li class="divider"></li>\n\n    <li class="multiselect-item-container">\n      <ul class="list-unstyled">\n        <li ng-repeat="role in vm.inventoryRoles | filter:vm.isAllowedByOwner | filter:vm.roleTextFilter | orderBy:vm.translateName" class="multiselect-item" ng-if="vm.isDropDownOpen">\n\n          <i c8y-icon="question-circle-o" class="pull-right text-info" ng-show="::role.description" uib-popover-html="vm.getFormattedInventoryRoleDescription(role.description)" popover-append-to-body="\'true\'" popover-trigger="\'mouseenter\'" popover-placement="right"></i>\n\n          <i c8y-icon="exclamation-circle" class="pull-right text-warning" ng-show="::vm.isInherited(role)" uib-popover="{{::\'This role is already assigned to a parent asset.\' | translate}}" popover-append-to-body="\'true\'" popover-trigger="\'mouseenter\'" popover-placement="right"></i>\n          <label class="c8y-checkbox input-sm" ng-click="::vm.toggle(role); $event.preventDefault()">\n            <input type="checkbox" ng-disabled="vm.isInherited(role)" ng-checked="vm.isSelected(role)" ng-click="::vm.toggle(role); $event.stopPropagation()" style="margin-top:0">\n            <span></span>\n            <span class="label-text" ng-bind="::role.name | translate"></span>\n          </label>\n        </li>\n      </ul>\n    </li>\n    <li class="divider"></li>\n    <li><button class="btn btn-primary btn-block" ng-click="::vm.apply()" ng-disabled="vm.saving" translate>Apply</button></li>\n  </ul>\n</div>\n',e.put("core_userRoles/inventoryRoleSelector/inventoryRoleSelector.html",n),e.put("/apps/core/userRoles/inventoryRoleSelector/inventoryRoleSelector.html",n),n='<div class="row">\n  <div class="col-md-6">\n    <div class="card">\n      <div class="card-header">\n        <h4 class="card-title" translate>Assign inventory roles to groups.</h4>\n      </div>\n      <hr>\n      <div class="card-block">\n        <p translate>The user will have the permissions in the inventory roles on the corresponding group and its children. Edit the set of roles for a group by clicking on the role names.</p>\n        <div class="input-group input-group-search">\n          <input class="form-control" placeholder="{{\'Search asset hierarchy\' | translate}}" ng-model="searchTearm">\n          <span class="input-group-addon">\n              <i c8y-icon="search" ng-class="{\'fa-spin\': loading}"></i>\n          </span>\n        </div>\n        <c8y-roles-asset-tree owner-assigned-roles="vm.ownerAssignedRoles" search-filter="searchTearm" assigned-roles="vm.assignedRoles" on-change-roles="vm.onChangeRoles(roles, managedObjectId)">\n        </c8y-roles-asset-tree>\n\n      </div>\n    </div>\n  </div>\n\n  <div class="col-md-5 col-md-offset-1">\n    <div>\n      <p translate>\n        An <strong>inventory role</strong> contains permissions that can be attached to devices and groups of devices. You can define own inventory roles <a href="#/roles">here</a>.\n      </p>\n      <p translate>\n        You can also copy inventory roles from another user or replace this user\'s roles with the roles of another user.\n      </p>\n    </div>\n\n    <p ng-show="::vm.helpLink">\n      <a ng-href="{{::vm.helpLink}}" target="_blank" class="btn btn-link btn-xs" target="_blank">\n        <i c8y-icon="question-circle-o"></i> <span translate>Help & Documentation</span>\n      </a>\n    </p>\n\n    <button type="button" class="btn btn-primary" ng-click="vm.copyRoles()" translate>Copy inventory roles from another user</button>\n  </div>\n\n</div>\n',e.put("core_userRoles/inventoryRolesTab/inventoryRolesTab.html",n),e.put("/apps/core/userRoles/inventoryRolesTab/inventoryRolesTab.html",n),n='<div class="roles-asset-tree-list">\n  <div ng-repeat="asset in vm.flatAssetTree | filter:vm.filterAsset | filter:{name:vm.searchFilter}" class="role-asset-tree-item">\n    <div ng-style="::{\'padding-left\': 5 + asset._depth * 15}" class="role-asset-tree-item_group">\n      <span class="text-truncate">\n        <i c8y-icon="folder" ng-hide="::asset._subGroups.length"></i>\n        <i c8y-icon="folder-open" ng-show="::asset._subGroups.length"></i>\n        {{::asset.name}}\n      </span>\n    </div>\n    <div class="role-asset-tree-item_selector">\n      <c8y-inventory-role-selector owner-allowed-roles="vm.ownerAllAssignedRoles[asset.id]" inherited-roles="vm.inheritedRoles[asset.id]" assigned-roles="vm.assignedRoles[asset.id]" inventory-roles="::vm.inventoryRoles" on-apply="::vm.onApply(roles, asset.id)">\n      </c8y-inventory-role-selector>\n    </div>\n  </div>\n</div>\n',e.put("core_userRoles/rolesAssetTree/rolesAssetTree.html",n),e.put("/apps/core/userRoles/rolesAssetTree/rolesAssetTree.html",n)}angular.module("c8y.userRoles").run(["$templateCache",e])}();