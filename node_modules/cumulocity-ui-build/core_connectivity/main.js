/* core_connectivity 8.7.2 2017-08-02T09:54:04+00:00 e22b35b1d531 (hotfix/8.7.2) tip */
!function(){"use strict";function t(t,n){function e(t,e,s,i,a,r,o){function l(n){u=n[1];var e=n[0];return e.valid&&u.c8y_Mobile&&u.c8y_Mobile.iccid?void(g=e.url.split("/").slice(0,3).join("/")):t.reject()}function c(){return u.c8y_Mobile.c8y_IsConnectivity?void 0:a.getTerminalDetails(m,{},{},{silentError:!0}).then(function(){return u.c8y_Mobile.c8y_IsConnectivity={},r.save(u)})}function d(){var e=u.c8y_Mobile.iccid,i=[{text:n("SIM details"),action:function(){var t=g+"/provision/ui/terminals/sims/simDetails.html?iccid="+e+"&dss=false&tabName=connections";window.open(t,"_blank")}}];return t.when(_.forEach(i,function(t){s.addAction(t)}))}var u,g,m=e.deviceId,v=o.detail(),h=r.detailCached(m).then(i.getResData),f=t.all([v,h]),b=a.safePing();return f.then(l).then(b).then(c).then(d).then(function(){return!0}).catch(function(){return!1})}t.when("/device/:deviceId",{templateUrl:"core_connectivity/views/index.html",name:n("Connectivity"),icon:"plug",showIfPermissions:{anyRole:["ROLE_CONNECTIVITY_READ"]},showIf:["$q","$routeParams","c8yActions","c8yBase","c8yConnectivity","c8yDevices","c8yConnectivitySettings",e]})}angular.module("c8y.connectivity",[]).config(["c8yViewsProvider","gettext",t])}(),function(){"use strict";function t(t,n,e,s,i,a,r,o,l){function c(){t.terminal&&n.all([d(),S(),y(),f()]).then(V).then(H)}function d(){g(),m(),v()}function u(t){if(t.dateFrom){var n=t.dateFrom;t.dateFrom=moment(n).format("ll"),t.cycleStartDate=moment(n).format("YYYY-MM-DD")}t.dateTo?t.dateTo=moment(t.dateTo).format("ll"):t.dateTo=moment().format("ll")}function g(){var n=_.find(J.statuses,function(n){return n.status===t.terminal.status});t.currentStatus=n.status}function m(){t.statusIcon=J.icons[t.terminal.suspended].icon}function v(){t.statusClass=J.icons[t.terminal.suspended].class}function h(t){Q.Data=t.usageDetails?(_.reduce(t.usageDetails,function(t,n){return t+n.dataVolume},0)/1e3).toFixed(3):0}function f(){return o.getTerminalDataUsage(e.deviceId,{},z).then(h)}function b(t){Q.Voice=t.voiceUsageDetails?_.reduce(t.voiceUsageDetails,function(t,n){return t+n.callDuration},0).toFixed(3):0}function y(){return o.getTerminalVoiceUsage(e.deviceId,{},z).then(b)}function p(t){return Q.Sms=t.smsUsageDetails?t.smsUsageDetails.length:0,t}function S(){return o.getTerminalSmsUsage(e.deviceId,{},z).then(p)}function T(t){var n={type:s(t),today:K.dateTo,thisMonthStart:K.dateFrom,lastMonthStart:z.dateFrom,lastMonthEnd:z.dateTo,lastMonthUsage:Q[t]};return i.getString("{{type}} usage this month to date ({{thisMonthStart}} - {{today}})\nUsage for last month ({{lastMonthStart}} - {{lastMonthEnd}}): {{lastMonthUsage}}",n)}function I(){var t=s("SIM status successfully changed");return a.success(t)}function D(t){return o.setTerminalSimStatus(e.deviceId,{targetValue:t}).then(function(){return n.all([U(),R()])}).then(c).then(I)}function M(){var n=s("SMS successfully sent");return t.message.messageText="",t.forms.messageForm.$setPristine(),a.success(n)}function w(t){return o.sendSms(e.deviceId,t).then(L).then(M)}function A(n){t.terminal=_.merge(X.terminal,_.head(n.terminals))}function x(n){n.sessionInfo?n.sessionInfo[0].inSession=s("Yes"):n.sessionInfo=[{inSession:s("No")}],t.session=_.head(n.sessionInfo)}function E(n){t.smss=n.smsMessages}function C(n){t.auditLogs=n.terminalAuditTrails}function N(n){t.sessions=n.usageDetails}function U(){return o.getTerminalDetails(e.deviceId).then(A)}function F(){return o.getTerminalSessionInfo(e.deviceId).then(x)}function L(){return o.getSms(e.deviceId).then(E)}function R(){return o.getTerminalAuditLogs(e.deviceId).then(C)}function O(){return o.getTerminalDataUsage(e.deviceId,{},K).then(N)}function V(){t.dataUsageTooltip=T("Data"),t.smsUsageTooltip=T("Sms"),t.voiceUsageTooltip=T("Voice")}function P(){return n.all([U(),F(),L(),R(),O()])}function Y(){return o.safePing()}function k(){return Y().then(P).then(c)}function q(){K=r.monthFilter(),z=r.monthFilter({},1),delete K.dateTo,u(K),u(z)}function $(n){t.isAdmin=n}function B(){return l.hasAnyRole(["ROLE_CONNECTIVITY_ADMIN"]).then($)}function H(){t.loading=!1}function j(){return t.loading=!0,n.all([k(),B()])}function W(){q(),j()}function G(t){return r.validationHints(t,tt)}var K,z,J={statuses:[{status:"ACTIVATED_NAME",text:s("Activated"),readOnly:!1},{status:"ACTIVATION_READY_NAME",text:s("Activation ready"),readOnly:!1},{status:"DEACTIVATED_NAME",text:s("Deactivated"),readOnly:!1},{status:"INVENTORY_NAME",text:s("Inventory"),readOnly:!1},{status:"PURGED_NAME",text:s("Purged"),readOnly:!0},{status:"REPLACED_NAME",text:s("Replaced"),readOnly:!0},{status:"RETIRED_NAME",text:s("Retired"),readOnly:!1},{status:"TEST_READY_NAME",text:s("Test ready"),readOnly:!0},{status:"TRIAL_NAME",text:s("Trial"),readOnly:!0}],icons:{N:{icon:"check-circle",class:"statusOk"},Y:{icon:"exclamation-circle",class:"statusNok"},F:{icon:"wrench",class:"statusAlert"}}},Q={},X={terminal:{fixedIpAddress:"-"}},Z="messageForm",tt={required:s("This field is required!")};t.message={},t.forms={},t.currentStatus="",t.loading=!0,t.statusMap=J,t.sendSms=w,t.setSimStatus=D,t.isAdmin=!1,t.reload=k,t.validationHints=G,t.invalid=angular.bind(r,r.invalid,t.forms,Z),W()}angular.module("c8y.connectivity").controller("connectivityCtrl",["$scope","$q","$routeParams","gettext","gettextCatalog","c8yAlert","c8yBase","c8yConnectivity","c8yPermissions",t])}(),function(){"use strict";function t(t){var n;n='<div ng-show="auditLogs.length > 0">\r\n  <div class="panel-heading">\r\n    <i c8y-icon="book"></i>\r\n    {{\'Audit logs\' | translate }}\r\n  </div>\r\n\r\n    <div class="panel-body">\r\n      <table class="table">\r\n        <thead>\r\n          <tr>\r\n            <th translate>Changed</th>\r\n            <th translate>From</th>\r\n            <th translate>To</th>\r\n            <th translate>When</th>\r\n            <th translate>Who</th>\r\n            <th translate>Status</th>\r\n          </tr>\r\n        </thead>\r\n        <tbody>\r\n          <tr ng-repeat="auditLog in auditLogs">\r\n            <td ng-bind="auditLog.field"></td>\r\n            <td ng-bind="auditLog.priorValue"></td>\r\n            <td ng-bind="auditLog.value"></td>\r\n            <td ng-bind="auditLog.effectiveDate | absoluteDate"></td>\r\n            <td ng-bind="auditLog.userName"></td>\r\n            <td ng-bind="auditLog.status"></td>\r\n          </tr>\r\n        </tbody>\r\n      </table>\r\n    </div>\r\n  </div>\r\n',t.put("core_connectivity/views/auditLogs.html",n),t.put("/apps/core/connectivity/views/auditLogs.html",n),n='<div ng-controller="connectivityCtrl" class="connectivity-plugin">\r\n  <div class="panel panel-clean">\r\n\r\n    <div class="clearfix">\r\n      <button class="btn btn-link pull-right" ng-disabled="loading" ng-click="reload()">\r\n        <i c8y-icon="refresh"></i>\r\n        <translate>Reload</translate>\r\n      </button>\r\n    </div>\r\n\r\n    <div ng-include="\'core_connectivity/views/status.html\'"></div>\r\n    <div ng-include="\'core_connectivity/views/sms.html\'"></div>\r\n    <div ng-include="\'core_connectivity/views/sessions.html\'"></div>\r\n    <div ng-include="\'core_connectivity/views/auditLogs.html\'"></div>\r\n\r\n  </div>\r\n</div>\r\n',t.put("core_connectivity/views/index.html",n),t.put("/apps/core/connectivity/views/index.html",n),n='<div ng-show="sessions.length > 0">\r\n  <div class="panel-heading">\r\n    <i c8y-icon="exchange"></i>\r\n    {{\'Sessions\' | translate }}\r\n  </div>\r\n\r\n  <div class="panel-body">\r\n    <table class="table">\r\n      <thead>\r\n        <tr>\r\n          <th translate>Customer</th>\r\n          <th translate>Started</th>\r\n          <th translate>Duration</th>\r\n          <th translate>Data usage (KB)</th>\r\n        </tr>\r\n      </thead>\r\n      <tbody>\r\n        <tr ng-repeat="session in sessions">\r\n          <td ng-bind="session.customer"></td>\r\n          <td ng-bind="session.sessionStartTime | absoluteDate"></td>\r\n          <td ng-bind="session.duration | duration"></td>\r\n          <td ng-bind="session.dataVolume"></td>\r\n        </tr>\r\n      </tbody>\r\n    </table>\r\n  </div>\r\n</div>\r\n',t.put("core_connectivity/views/sessions.html",n),t.put("/apps/core/connectivity/views/sessions.html",n),n='<div class="panel-heading" ng-show="smss.length > 0 || isAdmin">\r\n  <i c8y-icon="envelope"></i>\r\n  {{\'SMS\' | translate }}\r\n</div>\r\n\r\n<div class="panel-body">\r\n  <table class="table" ng-show="smss.length > 0">\r\n    <thead>\r\n      <tr>\r\n        <th translate>SMS ID</th>\r\n        <th translate>Date sent</th>\r\n        <th translate>Date received</th>\r\n        <th translate>Message text</th>\r\n        <th translate>Sent from</th>\r\n        <th translate>Sent to</th>\r\n        <th translate>Status</th>\r\n        <th translate>Message type</th>\r\n      </tr>\r\n    </thead>\r\n    <tbody>\r\n      <tr ng-repeat="sms in smss">\r\n        <td ng-bind="sms.smsMsgId"></td>\r\n        <td ng-bind="sms.dateSent | absoluteDate"></td>\r\n        <td ng-bind="sms.dateReceived | absoluteDate"></td>\r\n        <td ng-bind="sms.messageText"></td>\r\n        <td ng-bind="sms.sentFrom"></td>\r\n        <td ng-bind="sms.sentToIccid"></td>\r\n        <td ng-bind="sms.status"></td>\r\n        <td ng-bind="sms.msgType"></td>\r\n      </tr>\r\n    </tbody>\r\n  </table>\r\n  <form name="forms.messageForm" ng-if="isAdmin">\r\n    <div class="row" ng-class="{\'has-error\': invalid(\'mText\')}" uib-tooltip="{{validationHints(forms.messageForm.mText)}}">\r\n      <textarea required ng-model="message.messageText" name="mText" class="form-control form-group" rows="3"></textarea>\r\n    </div>\r\n\r\n    <div class="row">\r\n      <button ng-disabled="messageForm.$invalid" class="btn btn-primary" translate ng-click="sendSms(message)">Send SMS</button>\r\n    </div>\r\n  </form>\r\n</div>\r\n',t.put("core_connectivity/views/sms.html",n),t.put("/apps/core/connectivity/views/sms.html",n),n='<div class="panel-heading">\r\n  <i c8y-icon="mobile"></i>\r\n  <translate>Status</translate>\r\n</div>\r\n\r\n<div class="panel-body">\r\n  <form name="forms.terminalForm">\r\n    <div class="row">\r\n      <div class="form-group col-lg-6">\r\n        <label class="noicon" translate>In session</label>\r\n        <h4 ng-bind="session.inSession | translate"></h4>\r\n      </div>\r\n      <div ng-show="session.inSession === \'Yes\'">\r\n        <div class="form-group col-lg-3">\r\n          <label class="noicon" translate>Session start</label>\r\n          <h4 ng-bind="session.dateSessionStarted | absoluteDate"></h4>\r\n        </div>\r\n        <div class="form-group col-lg-3">\r\n          <label class="noicon" translate>Session IP address</label>\r\n          <h4 ng-bind="session.ipAddress"></h4>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    <div class="row">\r\n      <div class="form-group col-lg-3">\r\n        <label class="noicon" translate>ICCID</label>\r\n        <h4 ng-bind="terminal.iccid"></h4>\r\n      </div>\r\n      <div class="form-group col-lg-3">\r\n      </div>\r\n      <div class="form-group col-lg-6">\r\n        <label class="noicon" translate>Data usage (MB)</label>\r\n        <h4 class="wide-linebreak-tooltip">\r\n          {{terminal.monthToDateDataUsage}}\r\n          <i c8y-icon="question-circle-o" uib-tooltip="{{dataUsageTooltip}}" tooltip-placement="right"></i>\r\n        </h4>\r\n      </div>\r\n    </div>\r\n    <div class="row">\r\n      <div class="col-lg-6">\r\n        <label translate>SIM status</label>\r\n        <div class="row">\r\n          <div class="col-lg-6">\r\n            <select class="form-control" ng-model="currentStatus" ng-disabled="!isAdmin" ng-change="setSimStatus(currentStatus)">\r\n              <option ng-repeat="status in statusMap.statuses" ng-disabled="status.readOnly" ng-bind="status.text" ng-selected="status.status === currentStatus" value="{{status.status}}" translate>\r\n              </option>\r\n            </select>\r\n          </div>\r\n          <h4 class="col-lg-6"><i c8y-icon="{{statusIcon}}" ng-class="statusClass"></i></h4>\r\n        </div>\r\n      </div>\r\n      <div class="form-group col-lg-6">\r\n        <label class="noicon" translate>SMS usage</label>\r\n        <h4 class="wide-linebreak-tooltip">\r\n          {{terminal.monthToDateSMSUsage}}\r\n          <i c8y-icon="question-circle-o" uib-tooltip="{{smsUsageTooltip}}" tooltip-placement="right"></i>\r\n        </h4>\r\n      </div>\r\n    </div>\r\n    <div class="row">\r\n      <div class="form-group col-lg-6">\r\n        <label class="noicon" translate>Fixed IP address</label>\r\n        <h4 ng-bind="terminal.fixedIpAddress | translate"></h4>\r\n      </div>\r\n      <div class="form-group col-lg-6">\r\n        <label class="noicon" translate>Voice usage</label>\r\n        <h4 class="wide-linebreak-tooltip">\r\n          {{terminal.monthToDateVoiceUsage}}\r\n          <i c8y-icon="question-circle-o" uib-tooltip="{{voiceUsageTooltip}}" tooltip-placement="right"></i>\r\n        </h4>\r\n      </div>\r\n    </div>\r\n  </form>\r\n</div>\r\n',t.put("core_connectivity/views/status.html",n),t.put("/apps/core/connectivity/views/status.html",n)}angular.module("c8y.connectivity").run(["$templateCache",t])}();