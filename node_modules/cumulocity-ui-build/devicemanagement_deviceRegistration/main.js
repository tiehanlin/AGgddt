/* devicemanagement_deviceRegistration 8.7.2 2017-08-02T09:53:39+00:00 2e289fd803cb (hotfix/8.7.2) tip */
angular.module("c8y.parts.deviceRegistration",[]).config(["c8yNavigatorProvider","c8yViewsProvider","gettext",function(e,n,t){"use strict";e.addNavigation({parent:t("Devices"),name:t("Registration"),priority:3e3,path:"deviceregistration",icon:"c8y-device-connect",showIfPermissions:{anyRole:["ROLE_DEVICE_CONTROL_ADMIN","ROLE_DEVICE_CONTROL_READ"]}}),n.when("/deviceregistration",{templateUrl:"devicemanagement_deviceRegistration/views/index.html"})}]),function(){"use strict";function e(e,n,t,i,a,s,o,r,c,l,d,u,p,g,v,f,b){function h(){return f('Refer to "Bulk-registering devices" section in Device management\'s documentation to learn about proper file format.')}function m(e){return J[e.status]}function y(e){return c.list(e).then(w)}function w(e){D();var t=R();C(e,t),n.paging=e.paging}function D(){n.newDeviceRequests||(n.newDeviceRequests=[])}function R(){var e=[];return n.newDeviceRequests.forEach(function(n){e.push(n.id)}),e}function C(e,t){e.forEach(function(e){_.indexOf(t,e.id)===-1&&n.newDeviceRequests.push(e)})}function E(){n.paging.loading=!0,n.paging.next().then(w).finally(function(){n.paging.loading=!1})}function T(){n.newDeviceRequests=null,n.refreshLoading=!0,n.paging.refresh().then(w).finally(function(){n.refreshLoading=!1}),n.paging=null}function I(){l.addListener(n.$id,"/bootstrap",l.realtimeActions().UPDATE,k),l.start(n.$id,"/bootstrap"),n.$on("$destroy",function(){l.stop(n.$id,"/bootstrap")})}function k(e,t){n.newDeviceRequests.forEach(function(e){e.id===t.id&&(e.status=t.status,d.success(f("New device has been connected!")))})}function x(e){c.create(e).then(function(){d.success(f("Device has been registered and is waiting for being connected!"));var t={id:e.id,status:c.status.WAITING_FOR_CONNECTION},i=[];return i.push(t),i.statistics=n.paging.statistics,i.paging=n.paging,i}).then(w).then(N)}function q(){var e=n.forms.form_device_registration.id||{},t=[];return _.forEach(e.$error||{},function(e,n){var i=n.toUpperCase();e&&K[i]&&t.push(K[i].text)}),t.join(" ")}function A(){var e=!n.canReadInventory||n.newDevice.groupId;return e?f("Group is required"):""}function N(){n.newDevice?n.newDevice.id=null:n.newDevice={id:null}}function O(e){c.accept(e).then(function(){P(e),d.success(f("Device has been accepted!"))})}function P(e){var t=_.indexOf(n.newDeviceRequests,e);n.newDeviceRequests[t].status=c.status.ACCEPTED}function $(e){r({title:f("Confirm cancel?"),body:b.getString("Do you really want to cancel registration request for device with the id {{id}}?",{id:e.id}),status:"danger"}).then(function(){c.cancel(e).then(function(){S(e),d.success(f("Device registration has been cancelled!"))})})}function S(e){var t=_.indexOf(n.newDeviceRequests,e);n.newDeviceRequests.splice(t,1)}function U(e){u.changeTitle({title:f("Device registration"),subtitle:_.isUndefined(e)?"":b.getString("{{qty}} new devices",{qty:e})})}function F(e){var t=e[0];n.csvUpload={inProgress:!0},c.bulkCreate(t,{silentError:!0}).then(G,B).finally(W)}function G(e){e.data.numberOfSuccessful===e.data.numberOfAll?L(e):V(e),r({title:f("Device and/or groups added. Reload required."),body:f("In order to see changes in application you need to reload page. Do you want to reload now?"),labels:{ok:f("Reload now"),cancel:f("Reload later")}}).then(function(){a.location.reload()})}function L(e){M("success",b.getString("All devices have been successfully processed."),e.data)}function V(e){var n=_.assign(e.data,{numberOfFailures:e.data.numberOfAll-e.data.numberOfSuccessful}),t="danger",i=b.getPlural(n.numberOfFailures,'Failed to process one of the devices. Click "More" to get detailed information.','Failed to process {{numberOfFailures}} devices. Click "More" to get detailed information.',n);M(t,i,e.data)}function B(e){422===e.status?M("danger",b.getString("Invalid file format! Upload CSV file with the list of devices (see the question mark icon's tooltip for details)."),e.data):M("danger",b.getString(e.data.message)||b.getString("Error occurred while processing uploaded file!"),e.data)}function M(e,n,i){t.$emit("alert",{type:e,text:n,detailedData:i})}function W(){n.csvUpload={}}function j(e){n.isBulk=e,n.registerType=e?"Bulk":"Single"}function z(){e.all({user:g.current(),topTenant:p.isCurrentUserTopTenant(),tenantsRead:v.hasAnyRole(["ROLE_TENANT_MANAGEMENT_READ"])}).then(function(e){e.topTenant&&e.tenantsRead&&(n.showTenantField=!0,n.newDevice.tenantId=e.user.tenant,Y())})}function Y(){p.list().then(function(e){n.tenants=e})}function Q(){return p.isTopTenant(n.newDevice.tenantId)}function H(){v.hasAnyRole(["ROLE_INVENTORY_READ"]).then(function(e){n.canReadInventory=e})}var J={};J[c.status.PENDING_ACCEPTANCE]=1,J[c.status.WAITING_FOR_CONNECTION]=2,J[c.status.ACCEPTED]=3;var K={REQUIRED:{type:"required",text:f("Device ID is required.")},PATTERN:{type:"pattern_id",text:f('Device ID must not contain spaces or slashes ("/").')}};j(!1),n.deviceIdPattern=s.validation.deviceId.pattern,n.forms={},n.getCsvUploadTooltip=h,n.onCSVUpload=F,n.setBulk=j,n.listOrderExpression=[m,"id"],n.statusIcon=c.statusIcon,n.statusClass=c.statusClass,n.newDeviceRequestsStatus=c.status,n.onClickRegisterDevice=x,n.getErrorFeedback=q,n.getErrorGroupFeedback=A,n.invalidId=angular.bind(o,o.invalid,n.forms,"form_device_registration","id"),n.onClickAccept=O,n.onClickCancel=$,n.loadNext=E,n.refresh=T,n.$watch("newDeviceRequests.length",U),n.invalid=n.invalidId(),n.isTopTenantSelected=Q,N(),y(),I(),U(),z(),H()}e.$inject=["$q","$scope","$rootScope","$timeout","$window","c8yConfig","c8yBase","c8yModal","c8yDeviceRegistration","c8yRealtime","c8yAlert","c8yTitle","c8yTenant","c8yUser","c8yPermissions","gettext","gettextCatalog"],angular.module("c8y.parts.deviceRegistration").controller("deviceRegistrationCtrl",e)}(),function(){"use strict";function e(e){var n;n='<div data-ng-controller="deviceRegistrationCtrl">\n  <div class="c8y-toolbar-spacer page-toolbar">\n    <div class="c8y-toolbar navbar navbar-default">\n\n      <div class="navbar-header">\n        <button type="button" class="navbar-toggle collapsed" ng-click="isPageToolbarExpanded = !isPageToolbarExpanded">\n          <span translate class="sr-only">Toggle Toolbar</span>\n          <span class="icon-bar"></span>\n          <span class="icon-bar"></span>\n          <span class="icon-bar"></span>\n        </button>\n      </div>\n\n      <div id="page-toolbar" class="navbar-collapse" uib-collapse="!isPageToolbarExpanded">\n        <ul class="nav navbar-nav navbar-right">\n          <li class="navbar-form hidden-xs">\n          <div class="form-group">\n            <label translate>Display as </label>\n            <div class="input-group">\n              <div class="c8y-select-wrapper">\n                <select id="layout-switcher" class="form-control" ng-model="listClass" ng-init="listClass=\'interact-grid\'">\n                  <option value="interact-list" translate>List</option>\n                  <option value="interact-grid" translate>Grid</option>\n                </select>\n                <span></span>\n              </div>\n            </div>\n          </div>\n        </li>\n          <li>\n            <div class="dropdown" uib-dropdown="">\n              <button class="dropdown-toggle c8y-dropdown btn btn-link" uib-dropdown-toggle>\n                <i c8y-icon="plus-square" class="fa fw fa-plus-square"></i> <span translate="">Register device</span>\n              </button>\n              <ul class="dropdown-menu visible-overflow" uib-dropdown-menu>\n                <li class="dropdown-form" ng-click="$event.stopPropagation()">\n                  <div ng-form="forms.form_device_registration">\n\n                    <div class="form-group">\n                      <!-- REVIEW: do we need this in the form-group: ng-class="{\'has-error\': invalidId() }" ?\n                      this marks the field with error after adding a new deviceâ€¦\n                     -->\n                      <input type="text" class="form-control" name="id" ng-keydown="$event.keyCode == 13 && onClickRegisterDevice(newDevice)" placeholder="{{\'Device ID\' | translate}}" ng-model="newDevice.id" maxlength="150" data-ng-required="true" ng-pattern="deviceIdPattern" uib-tooltip="{{getErrorFeedback() | translate}}" c8y-autocomplete="off" autocorrect="off" autocapitalize="off">\n                    </div>\n                    <div class="form-group" ng-if="showTenantField">\n                      <ui-select ng-model="newDevice.tenantId" uib-tooltip="{{\'You can add device to specific group for management tenant only.\' | translate}}">\n                        <ui-select-match placeholder="{{\'Add to tenant\' | translate}}">{{newDevice.tenantId}}</ui-select-match>\n                        <ui-select-choices repeat="t.id as t in tenants | filter: {id: $select.search} | orderBy:\'id\'" position="down">\n                          <div ng-bind-html="t.id | highlight: $select.search" title="{{t.id}}"></div>\n                        </ui-select-choices>\n                      </ui-select>\n                    </div>\n                    <input type="hidden" name="groupId" ng-model="newDevice.groupId" ng-required="!canReadInventory">\n                    <div class="form-group" uib-tooltip="{{getErrorGroupFeedback() | translate}}" ng-if="isTopTenantSelected() || !showTenantField">\n                      <c8y-device-group-selector uib-tooltip="{{getErrorGroupFeedback() | translate}}" group="newDevice.groupId" group-as-id="true" placeholder="{{\'Add to group\' | translate}}">\n                      </c8y-device-group-selector>\n                    </div>\n                    <button class="btn btn-primary btn-block" data-ng-disabled="forms.form_device_registration.$invalid" ng-click="onClickRegisterDevice(newDevice)">\n                      {{\'Register device\' | translate}}\n                    </button>\n                  </div>\n                </li>\n              </ul>\n            </div>\n          </li>\n\n          <li>\n            <button class="btn btn-link" ng-file-select="onCSVUpload($files)" data-accept="text/*" ng-disabled="csvUpload.inProgress">\n              <span ng-hide="csvUpload.inProgress"><i c8y-icon="upload"></i> {{\'Upload\' | translate}}</span>\n              <span ng-show="csvUpload.inProgress"><i c8y-icon="spinner" class="fa-spin"></i></span>\n            </button>\n            <span>\n              <a href style="display: inline-block" class="hidden-xs" uib-popover="{{getCsvUploadTooltip() | translate}}" popover-placement="bottom" popover-append-to-body="true" popover-trigger="\'focus\'">\n                <i c8y-icon="question-circle-o"></i>\n              </a>\n            </span>\n          </li>\n          <li>\n            <c8y-refresh-btn></c8y-refresh-btn>\n          </li>\n        </ul>\n      </div>\n    </div>\n  </div><!-- toolbar spacer -->\n\n    <!-- empty state -->\n  <div class="c8y-empty-state text-center" ng-show="newDeviceRequests.length == 0">\n    <h1 class="c8y-icon c8y-icon-device-connect c8y-icon-duocolor"></h1>\n    <h3 translate>No devices to display.</h3>\n    <p translate>Register devices using the buttons on the toolbar.</p>\n  </div>\n  <!-- /.empty state -->\n\n\n  <div class="card-group" ng-class="listClass">\n    <div class="col-xs-12 col-sm-6 col-md-4 col-lg-3" data-ng-repeat="d in newDeviceRequests | orderBy: listOrderExpression">\n      <div class="card">\n        <div class="card-header">\n          <div class="card-icon">\n            <i c8y-icon="{{statusIcon(d)}}" data-ng-class="statusClass(d)"></i>\n          </div>\n          <p class="card-title text-truncate">{{d.id}}</p>\n        </div>\n        <hr>\n        <div class="card-actions-group">\n          <button class="btn btn-danger btn-xs" data-ng-click="onClickCancel(d)">\n            {{\'Cancel\' | translate}}\n          </button>\n          <button class="btn btn-primary btn-xs" data-ng-click="onClickAccept(d)" data-ng-show="d.status==newDeviceRequestsStatus.PENDING_ACCEPTANCE">\n            {{\'Accept\' | translate}}\n          </button>\n        </div>\n        <div class="card-block text-center">\n          <small class="text-muted">\n            <strong>{{\'Status\' | translate}}:</strong> {{d.status | humanize | translate}}\n          </small><br>\n        </div>\n      </div>\n    </div>\n  </div>\n\n  <c8y-load-more></c8y-load-more>\n\n</div>\n',e.put("devicemanagement_deviceRegistration/views/index.html",n),e.put("/apps/devicemanagement/deviceRegistration/views/index.html",n)}angular.module("c8y.parts.deviceRegistration").run(["$templateCache",e])}();